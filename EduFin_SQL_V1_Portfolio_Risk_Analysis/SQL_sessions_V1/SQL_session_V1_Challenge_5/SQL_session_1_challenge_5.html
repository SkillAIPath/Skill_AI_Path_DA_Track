<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Session 5: Portfolio Performance Trends Analysis</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            line-height: 1.6;
            color: #333;
            background: white;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            page-break-inside: avoid;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .crisis-alert {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .section {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }
        
        .section h2 {
            color: #2c3e50;
            font-size: 1.6em;
            margin-bottom: 15px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 8px;
        }
        
        .section h3 {
            color: #34495e;
            font-size: 1.3em;
            margin: 20px 0 12px 0;
        }
        
        .section h4 {
            color: #2980b9;
            font-size: 1.1em;
            margin: 15px 0 8px 0;
        }
        
        .business-question {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #27ae60;
        }
        
        .objective-box {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            border: 1px solid #4a5568;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            white-space: pre;
        }
        
        .sql-keyword {
            color: #63b3ed;
            font-weight: bold;
        }
        
        .sql-function {
            color: #f687b3;
            font-weight: bold;
        }
        
        .sql-string {
            color: #68d391;
        }
        
        .code-comment {
            color: #a0aec0;
            font-style: italic;
        }
        
        .output-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 12px;
        }
        
        .output-table th {
            background: #34495e;
            color: white;
            padding: 10px;
            text-align: left;
            border: 1px solid #2c3e50;
        }
        
        .output-table td {
            padding: 8px 10px;
            border: 1px solid #bdc3c7;
            background: white;
        }
        
        .output-table tr:nth-child(even) td {
            background: #f8f9fa;
        }
        
        .learning-tip {
            background: #fff3cd;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            border-left: 4px solid #ffc107;
        }
        
        .learning-tip h4 {
            color: #856404;
            margin-bottom: 8px;
        }
        
        .validation-box {
            background: #d4edda;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }
        
        .warning-box {
            background: #f8d7da;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #dc3545;
        }
        
        .info-box {
            background: #d1ecf1;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #17a2b8;
        }
        
        .insights-box {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #0066cc;
        }
        
        .insights-box h4 {
            color: #0066cc;
            margin-bottom: 8px;
        }
        
        .final-output {
            background: #e6f3ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #0066cc;
        }
        
        .summary-section {
            background: #f0f8f0;
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
            border: 3px solid #27ae60;
        }
        
        .summary-section h2 {
            color: #2d5a2d;
            font-size: 1.8em;
            margin-bottom: 20px;
            border-bottom: 3px solid #27ae60;
            padding-bottom: 10px;
        }
        
        .breakdown-list {
            list-style: none;
            padding: 0;
        }
        
        .breakdown-list li {
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .breakdown-list li:last-child {
            border-bottom: none;
        }
        
        .page-break {
            page-break-before: always;
        }
        
        ul, ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        li {
            margin-bottom: 5px;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 15px;
            color: #6c757d;
            font-size: 12px;
            border-top: 1px solid #dee2e6;
        }
        
        @media print {
            body {
                font-size: 11px;
            }
            
            .section {
                margin-bottom: 20px;
            }
            
            .code-block {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>📈 SQL Session 5: Portfolio Performance Trends</h1>
        <h2>EduFin Time Intelligence Crisis Analysis</h2>
        <p>"When did our lending standards collapse and how do we predict future failures?"</p>
    </div>

    <div class="crisis-alert">
        🚨 TEMPORAL CRISIS: Q3 2024 cohort showing 45% higher default rates than Q1 2023 - lending standards deteriorated systematically
    </div>

    <div class="business-question">
        <h3>📋 BUSINESS QUESTION: "When did our lending standards collapse and how do we predict future failures?"</h3>
        <p><strong>Query Objective:</strong> Following Sessions 1-4 confirmation of crisis scale (₹49.4 Cr losses), geography (₹1.59 Cr from 5 cities), customer segments (high-income failures), and institution partnerships (3 termination targets), we now analyze WHEN the crisis began and how different loan cohorts perform over time to prevent future disasters.</p>
        <p><strong>Final Output:</strong> Time-based cohort analysis, seasonal lending patterns, performance deterioration timeline, and predictive insights for future loan portfolios using advanced date/time intelligence functions.</p>
    </div>

    <div class="section">
        <h2>🎯 SESSION LEARNING OBJECTIVES</h2>
        
        <div class="objective-box">
            <h3>🎯 Business Intelligence Goals</h3>
            <ul>
                <li><strong>Crisis Timeline Mapping:</strong> Identify exactly when lending standards deteriorated</li>
                <li><strong>Cohort Performance Analysis:</strong> Compare loan vintage performance for quality patterns</li>
                <li><strong>Seasonal Risk Patterns:</strong> Discover if certain months/quarters produce higher-risk loans</li>
                <li><strong>Predictive Modeling:</strong> Forecast future default rates based on disbursement timing trends</li>
            </ul>
        </div>

        <div class="objective-box">
            <h3>🔧 Advanced SQL Time Intelligence Mastery</h3>
            <ul>
                <li><strong>Date Functions:</strong> YEAR(), MONTH(), QUARTER(), DATEDIFF(), DATEADD()</li>
                <li><strong>Time Period Comparisons:</strong> Period-over-period growth analysis</li>
                <li><strong>Cohort Analysis:</strong> Vintage performance tracking with date-based groupings</li>
                <li><strong>Seasonal Analysis:</strong> Cyclic pattern identification and trend analysis</li>
                <li><strong>Predictive Time Intelligence:</strong> Forward-looking projections based on historical patterns</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h2>🧩 STEP-BY-STEP TIME INTELLIGENCE ANALYSIS</h2>
        
        <h3>STEP 5A: Loan Cohort Performance Analysis</h3>
        <p><strong>Analytical Purpose:</strong> Analyze loan performance by disbursement vintage to identify when quality deteriorated.</p>
        
        <div class="code-block"><span class="code-comment">-- Step 5A: Loan cohort analysis using date functions and period grouping</span>
<span class="sql-keyword">SELECT</span> 
    <span class="code-comment">-- Time period groupings</span>
    <span class="sql-function">YEAR</span>(l.disbursement_date) <span class="sql-keyword">AS</span> disbursement_year,
    <span class="sql-function">QUARTER</span>(l.disbursement_date) <span class="sql-keyword">AS</span> disbursement_quarter,
    <span class="sql-function">CONCAT</span>(<span class="sql-function">YEAR</span>(l.disbursement_date), <span class="sql-string">'-Q'</span>, <span class="sql-function">QUARTER</span>(l.disbursement_date)) <span class="sql-keyword">AS</span> disbursement_quarter_label,
    
    <span class="code-comment">-- Cohort portfolio metrics</span>
    <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> loans_disbursed,
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">DISTINCT</span> l.customer_id) <span class="sql-keyword">AS</span> unique_customers,
    <span class="sql-function">ROUND</span>(<span class="sql-function">SUM</span>(l.loan_amount)/10000000, 2) <span class="sql-keyword">AS</span> cohort_value_cr,
    <span class="sql-function">ROUND</span>(<span class="sql-function">AVG</span>(l.loan_amount), 0) <span class="sql-keyword">AS</span> avg_loan_size,
    
    <span class="code-comment">-- Performance metrics by cohort</span>
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_loans,
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
        <span class="sql-function">COUNT</span>(l.loan_id), 2
    ) <span class="sql-keyword">AS</span> cohort_default_rate,
    
    <span class="code-comment">-- Financial impact by cohort</span>
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> l.loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>)/10000000, 2
    ) <span class="sql-keyword">AS</span> cohort_losses_cr,
    
    <span class="code-comment">-- Time-based aging analysis</span>
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">AVG</span>(<span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>())), 0
    ) <span class="sql-keyword">AS</span> avg_loan_age_days,
    
    <span class="code-comment">-- Maturity-adjusted default rate (important for fair comparison)</span>
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) >= 180 <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>), 2
    ) <span class="sql-keyword">AS</span> mature_cohort_default_rate

<span class="sql-keyword">FROM</span> loans l

<span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
    <span class="sql-keyword">AND</span> l.disbursement_date >= <span class="sql-string">'2023-01-01'</span>  <span class="code-comment">-- Focus on recent 2 years</span>
    
<span class="sql-keyword">GROUP BY</span> 
    <span class="sql-function">YEAR</span>(l.disbursement_date),
    <span class="sql-function">QUARTER</span>(l.disbursement_date)
    
<span class="sql-keyword">HAVING</span> <span class="sql-function">COUNT</span>(l.loan_id) >= 50  <span class="code-comment">-- Significant cohort size</span>
    
<span class="sql-keyword">ORDER BY</span> 
    disbursement_year <span class="sql-keyword">DESC</span>, 
    disbursement_quarter <span class="sql-keyword">DESC</span>;</div>

        <h4>Expected Output (Loan Cohort Performance):</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>disbursement_year</th>
                    <th>disbursement_quarter</th>
                    <th>disbursement_quarter_label</th>
                    <th>loans_disbursed</th>
                    <th>unique_customers</th>
                    <th>cohort_value_cr</th>
                    <th>avg_loan_size</th>
                    <th>defaulted_loans</th>
                    <th>cohort_default_rate</th>
                    <th>cohort_losses_cr</th>
                    <th>avg_loan_age_days</th>
                    <th>mature_cohort_default_rate</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>2025</td>
                    <td>2</td>
                    <td>2025-Q1</td>
                    <td>298</td>
                    <td>280</td>
                    <td>12.72</td>
                    <td>426953</td>
                    <td>35</td>
                    <td>11</td>
                    <td>1.42</td>
                    <td>88</td>
                    <td>NULL</td>
                </tr>
                <tr>
                    <td>2025</td>
                    <td>1</td>
                    <td>2025-Q1</td>
                    <td>307</td>
                    <td>299</td>
                    <td>12.27</td>
                    <td>399532</td>
                    <td>34</td>
                    <td>11</td>
                    <td>1.58</td>
                    <td>175</td>
                    <td>22</td>
                </tr>
                <tr>
                    <td>2024</td>
                    <td>4</td>
                    <td>2024-Q4</td>
                    <td>336</td>
                    <td>323</td>
                    <td>13.63</td>
                    <td>405691</td>
                    <td>43</td>
                    <td>12</td>
                    <td>1.72</td>
                    <td>262</td>
                    <td>12</td>
                </tr>
                <tr>
                    <td>2024</td>
                    <td>3</td>
                    <td>2024-Q3</td>
                    <td>329</td>
                    <td>322</td>
                    <td>13.7</td>
                    <td>416502</td>
                    <td>37</td>
                    <td>11</td>
                    <td>1.36</td>
                    <td>357</td>
                    <td>11</td>
                </tr>
                <tr>
                    <td>2024</td>
                    <td>2</td>
                    <td>2024-Q2</td>
                    <td>310</td>
                    <td>299</td>
                    <td>12.87</td>
                    <td>415112</td>
                    <td>29</td>
                    <td>9</td>
                    <td>1.21</td>
                    <td>443</td>
                    <td>9</td>
                </tr>
                <tr>
                    <td>2024</td>
                    <td>1</td>
                    <td>2024-Q1</td>
                    <td>331</td>
                    <td>327</td>
                    <td>13.21</td>
                    <td>399007</td>
                    <td>44</td>
                    <td>13</td>
                    <td>1.69</td>
                    <td>538</td>
                    <td>13</td>
                </tr>
                <tr>
                    <td>2023</td>
                    <td>4</td>
                    <td>2023-Q4</td>
                    <td>345</td>
                    <td>327</td>
                    <td>14.45</td>
                    <td>418848</td>
                    <td>48</td>
                    <td>13</td>
                    <td>2.12</td>
                    <td>629</td>
                    <td>13</td>
                </tr>
                <tr>
                    <td>2023</td>
                    <td>3</td>
                    <td>2023-Q3</td>
                    <td>316</td>
                    <td>307</td>
                    <td>13.16</td>
                    <td>416344</td>
                    <td>49</td>
                    <td>15</td>
                    <td>2.11</td>
                    <td>721</td>
                    <td>15</td>
                </tr>
                <tr>
                    <td>2023</td>
                    <td>2</td>
                    <td>2023-Q2</td>
                    <td>324</td>
                    <td>311</td>
                    <td>13</td>
                    <td>401320</td>
                    <td>36</td>
                    <td>11</td>
                    <td>1.42</td>
                    <td>811</td>
                    <td>11</td>
                </tr>
                <tr>
                    <td>2023</td>
                    <td>1</td>
                    <td>2023-Q1</td>
                    <td>322</td>
                    <td>310</td>
                    <td>13.19</td>
                    <td>409580</td>
                    <td>42</td>
                    <td>13</td>
                    <td>1.87</td>
                    <td>904</td>
                    <td>13</td>
                </tr>
            </tbody>
        </table>

        <div class="insights-box">
            <h4>🎯 WHY Cohort Analysis is Critical:</h4>
            <p>Cohort analysis reveals lending quality patterns over time, showing that performance varies by quarter with some periods showing better control than others.</p>
            
            <h4>🔍 WHAT Cohort Analysis Reveals:</h4>
            <ul>
                <li><strong>Performance Stability:</strong> Default rates consistently range between 9-15% across quarters</li>
                <li><strong>Recent Improvement:</strong> 2024-Q2 showing 9% vs 2023-Q3 showing 15%</li>
                <li><strong>Financial Impact Tracking:</strong> Losses range from ₹1.21 Cr to ₹2.12 Cr per quarter</li>
                <li><strong>Mature Loan Analysis:</strong> Age-adjusted analysis shows consistent patterns</li>
            </ul>
            
            <h4>💡 KEY TIME INTELLIGENCE INSIGHTS:</h4>
            <ul>
                <li><strong>Seasonal Variation:</strong> Performance varies by quarter but shows manageable ranges</li>
                <li><strong>Portfolio Control:</strong> Recent quarters show better performance management</li>
                <li><strong>Vintage Comparison:</strong> Fair comparison requires age adjustments for recent loans</li>
                <li><strong>Portfolio Aging:</strong> Average loan age provides context for default rate interpretation</li>
            </ul>
        </div>

        <div class="learning-tip">
            <h4>✅ Date Function Mastery:</h4>
            <ul class="breakdown-list">
                <li><strong>YEAR(date), QUARTER(date):</strong> Extract time period components for grouping</li>
                <li><strong>DATEDIFF(DAY, start, end):</strong> Calculate days between dates for aging analysis</li>
                <li><strong>GETDATE():</strong> Current date for calculating loan age</li>
                <li><strong>Mature Cohort Analysis:</strong> Only compare loans with sufficient aging (180+ days)</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h3>STEP 5B: Monthly Lending Pattern Analysis</h3>
        <p><strong>Analytical Purpose:</strong> Identify seasonal patterns and monthly risk variations in loan origination.</p>
        
        <div class="code-block"><span class="code-comment">-- Step 5B: Monthly lending patterns with seasonal analysis</span>
<span class="sql-keyword">SELECT</span> 
    <span class="code-comment">-- Time period extraction</span>
    <span class="sql-function">MONTH</span>(l.disbursement_date) <span class="sql-keyword">AS</span> disbursement_month,
    <span class="sql-function">DATENAME</span>(<span class="sql-function">MONTH</span>, l.disbursement_date) <span class="sql-keyword">AS</span> month_name,
    
    <span class="code-comment">-- Seasonal classification</span>
    <span class="sql-keyword">CASE</span>
        <span class="sql-keyword">WHEN</span> <span class="sql-function">MONTH</span>(l.disbursement_date) <span class="sql-keyword">IN</span> (6, 7, 8) <span class="sql-keyword">THEN</span> <span class="sql-string">'Academic Start'</span>
        <span class="sql-keyword">WHEN</span> <span class="sql-function">MONTH</span>(l.disbursement_date) <span class="sql-keyword">IN</span> (11, 12, 1) <span class="sql-keyword">THEN</span> <span class="sql-string">'Mid-Academic Year'</span>
        <span class="sql-keyword">WHEN</span> <span class="sql-function">MONTH</span>(l.disbursement_date) <span class="sql-keyword">IN</span> (3, 4, 5) <span class="sql-keyword">THEN</span> <span class="sql-string">'Academic End'</span>
        <span class="sql-keyword">ELSE</span> <span class="sql-string">'Transition Period'</span>
    <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> academic_season,
    
    <span class="code-comment">-- Monthly portfolio metrics across all years</span>
    <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> total_loans_all_years,
    <span class="sql-function">ROUND</span>(<span class="sql-function">AVG</span>(l.loan_amount), 0) <span class="sql-keyword">AS</span> avg_monthly_loan_size,
    <span class="sql-function">ROUND</span>(<span class="sql-function">SUM</span>(l.loan_amount)/10000000, 2) <span class="sql-keyword">AS</span> total_monthly_volume_cr,
    
    <span class="code-comment">-- Risk analysis by month</span>
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_loans,
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
        <span class="sql-function">COUNT</span>(l.loan_id), 2
    ) <span class="sql-keyword">AS</span> monthly_default_rate,
    
    <span class="code-comment">-- Mature loans only (fairer comparison)</span>
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) >= 180 <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> mature_loans,
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> 
                     <span class="sql-keyword">AND</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) >= 180 
                     <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
        <span class="sql-function">NULLIF</span>(<span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) >= 180 <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>), 0), 2
    ) <span class="sql-keyword">AS</span> mature_monthly_default_rate,
    
    <span class="code-comment">-- Financial impact by month</span>
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> l.loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>)/10000000, 2
    ) <span class="sql-keyword">AS</span> monthly_losses_cr,
    
    <span class="code-comment">-- Risk classification by month</span>
    <span class="sql-keyword">CASE</span> 
        <span class="sql-keyword">WHEN</span> <span class="sql-function">ROUND</span>(
            <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> 
                         <span class="sql-keyword">AND</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) >= 180 
                         <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
            <span class="sql-function">NULLIF</span>(<span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) >= 180 <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>), 0), 2
        ) > 15 <span class="sql-keyword">THEN</span> <span class="sql-string">'HIGH RISK MONTH'</span>
        <span class="sql-keyword">WHEN</span> <span class="sql-function">ROUND</span>(
            <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> 
                         <span class="sql-keyword">AND</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) >= 180 
                         <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
            <span class="sql-function">NULLIF</span>(<span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) >= 180 <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>), 0), 2
        ) < 8 <span class="sql-keyword">THEN</span> <span class="sql-string">'LOW RISK MONTH'</span>
        <span class="sql-keyword">ELSE</span> <span class="sql-string">'MEDIUM RISK MONTH'</span>
    <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> monthly_risk_level

<span class="sql-keyword">FROM</span> loans l

<span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
    <span class="sql-keyword">AND</span> l.disbursement_date >= <span class="sql-string">'2023-01-01'</span>
    
<span class="sql-keyword">GROUP BY</span> 
    <span class="sql-function">MONTH</span>(l.disbursement_date),
    <span class="sql-function">DATENAME</span>(<span class="sql-function">MONTH</span>, l.disbursement_date)
    
<span class="sql-keyword">HAVING</span> <span class="sql-function">COUNT</span>(l.loan_id) >= 25  <span class="code-comment">-- Meaningful sample size</span>
    
<span class="sql-keyword">ORDER BY</span> disbursement_month;</div>

        <h4>Expected Output (Monthly Seasonal Analysis):</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>disbursement_month</th>
                    <th>month_name</th>
                    <th>academic_season</th>
                    <th>total_loans_all_years</th>
                    <th>avg_monthly_loan_size</th>
                    <th>total_monthly_volume_cr</th>
                    <th>defaulted_loans</th>
                    <th>monthly_default_rate</th>
                    <th>mature_loans</th>
                    <th>mature_monthly_default_rate</th>
                    <th>monthly_losses_cr</th>
                    <th>monthly_risk_level</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1</td>
                    <td>January</td>
                    <td>Mid-Academic Year</td>
                    <td>376</td>
                    <td>393066</td>
                    <td>14.78</td>
                    <td>45</td>
                    <td>11</td>
                    <td>376</td>
                    <td>11</td>
                    <td>1.87</td>
                    <td>MEDIUM RISK MONTH</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>February</td>
                    <td>Transition Period</td>
                    <td>282</td>
                    <td>406497</td>
                    <td>11.46</td>
                    <td>37</td>
                    <td>13</td>
                    <td>226</td>
                    <td>14</td>
                    <td>1.6</td>
                    <td>MEDIUM RISK MONTH</td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>March</td>
                    <td>Academic End</td>
                    <td>302</td>
                    <td>411216</td>
                    <td>12.42</td>
                    <td>38</td>
                    <td>12</td>
                    <td>204</td>
                    <td>12</td>
                    <td>1.67</td>
                    <td>MEDIUM RISK MONTH</td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>April</td>
                    <td>Academic End</td>
                    <td>317</td>
                    <td>411213</td>
                    <td>13.04</td>
                    <td>31</td>
                    <td>9</td>
                    <td>197</td>
                    <td>10</td>
                    <td>1.29</td>
                    <td>MEDIUM RISK MONTH</td>
                </tr>
                <tr>
                    <td>5</td>
                    <td>May</td>
                    <td>Academic End</td>
                    <td>329</td>
                    <td>407265</td>
                    <td>13.4</td>
                    <td>40</td>
                    <td>12</td>
                    <td>210</td>
                    <td>10</td>
                    <td>1.6</td>
                    <td>MEDIUM RISK MONTH</td>
                </tr>
            </tbody>
        </table>

        <div class="insights-box">
            <h4>🎯 WHY Seasonal Analysis is Strategic:</h4>
            <p>Academic calendar drives lending patterns and risk profiles. Understanding monthly variations helps optimize lending strategies and resource allocation throughout the year.</p>
            
            <h4>🔍 WHAT Seasonal Patterns Reveal:</h4>
            <ul>
                <li><strong>Consistent Performance:</strong> Monthly default rates ranging from 9-13% across different academic seasons</li>
                <li><strong>Volume Patterns:</strong> January shows highest loan volume (376 loans) compared to other months</li>
                <li><strong>Academic End Period:</strong> March-May showing stable 9-12% default rates</li>
                <li><strong>Risk Classification:</strong> All shown months classified as medium risk, indicating stable performance</li>
            </ul>
            
            <h4>💡 KEY SEASONAL INSIGHTS:</h4>
            <ul>
                <li><strong>Stable Risk Profile:</strong> Monthly variations are within acceptable ranges</li>
                <li><strong>Academic Calendar Alignment:</strong> Different academic seasons show manageable risk levels</li>
                <li><strong>Volume Management:</strong> Balanced distribution across months with some seasonal peaks</li>
                <li><strong>Consistent Standards:</strong> Lending standards appear consistent across different periods</li>
            </ul>
        </div>

        <div class="learning-tip">
            <h4>✅ Seasonal Analysis Mastery:</h4>
            <ul class="breakdown-list">
                <li><strong>MONTH(), DATENAME():</strong> Extract month numbers and names for grouping</li>
                <li><strong>Seasonal Classification:</strong> CASE statements to group months by business context</li>
                <li><strong>NULLIF() Function:</strong> Prevents division by zero in percentage calculations</li>
                <li><strong>Cross-Year Analysis:</strong> Aggregate across multiple years for reliable patterns</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h3>STEP 5C: Period-over-Period Performance Analysis</h3>
        <p><strong>Analytical Purpose:</strong> Compare performance across different time periods to identify deterioration trends.</p>
        
        <div class="code-block"><span class="code-comment">-- Step 5C: Period-over-period performance analysis with DATEADD and period comparisons</span>
<span class="sql-keyword">WITH</span> quarterly_metrics <span class="sql-keyword">AS</span> (
    <span class="sql-keyword">SELECT</span> 
        <span class="sql-function">YEAR</span>(l.disbursement_date) <span class="sql-keyword">AS</span> loan_year,
        <span class="sql-function">QUARTER</span>(l.disbursement_date) <span class="sql-keyword">AS</span> loan_quarter,
        <span class="sql-function">CONCAT</span>(<span class="sql-function">YEAR</span>(l.disbursement_date), <span class="sql-string">'-Q'</span>, <span class="sql-function">QUARTER</span>(l.disbursement_date)) <span class="sql-keyword">AS</span> period,
        
        <span class="code-comment">-- Quarter start date for period calculations</span>
        <span class="sql-function">DATEFROMPARTS</span>(<span class="sql-function">YEAR</span>(l.disbursement_date), 
                         (<span class="sql-function">QUARTER</span>(l.disbursement_date) - 1) * 3 + 1, 1) <span class="sql-keyword">AS</span> quarter_start_date,
        
        <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> loans_originated,
        <span class="sql-function">ROUND</span>(<span class="sql-function">SUM</span>(l.loan_amount)/10000000, 2) <span class="sql-keyword">AS</span> origination_volume_cr,
        <span class="sql-function">ROUND</span>(<span class="sql-function">AVG</span>(l.loan_amount), 0) <span class="sql-keyword">AS</span> avg_loan_amount,
        
        <span class="code-comment">-- Performance metrics</span>
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_loans,
        <span class="sql-function">ROUND</span>(
            <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
            <span class="sql-function">COUNT</span>(l.loan_id), 2
        ) <span class="sql-keyword">AS</span> default_rate,
        
        <span class="sql-function">ROUND</span>(
            <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> l.loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>)/10000000, 2
        ) <span class="sql-keyword">AS</span> losses_cr
        
    <span class="sql-keyword">FROM</span> loans l
    <span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
        <span class="sql-keyword">AND</span> l.disbursement_date >= <span class="sql-string">'2023-01-01'</span>
    <span class="sql-keyword">GROUP BY</span> 
        <span class="sql-function">YEAR</span>(l.disbursement_date),
        <span class="sql-function">QUARTER</span>(l.disbursement_date)
    <span class="sql-keyword">HAVING</span> <span class="sql-function">COUNT</span>(l.loan_id) >= 50
),

period_comparisons <span class="sql-keyword">AS</span> (
    <span class="sql-keyword">SELECT</span> 
        *,
        <span class="code-comment">-- Previous period metrics using LAG with 1 quarter offset</span>
        <span class="sql-function">LAG</span>(loans_originated, 1) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> loan_year, loan_quarter) <span class="sql-keyword">AS</span> prev_quarter_loans,
        <span class="sql-function">LAG</span>(origination_volume_cr, 1) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> loan_year, loan_quarter) <span class="sql-keyword">AS</span> prev_quarter_volume,
        <span class="sql-function">LAG</span>(default_rate, 1) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> loan_year, loan_quarter) <span class="sql-keyword">AS</span> prev_quarter_default_rate,
        <span class="sql-function">LAG</span>(losses_cr, 1) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> loan_year, loan_quarter) <span class="sql-keyword">AS</span> prev_quarter_losses,
        
        <span class="code-comment">-- Year-over-year metrics using LAG with 4 quarter offset</span>
        <span class="sql-function">LAG</span>(loans_originated, 4) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> loan_year, loan_quarter) <span class="sql-keyword">AS</span> yoy_loans,
        <span class="sql-function">LAG</span>(default_rate, 4) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> loan_year, loan_quarter) <span class="sql-keyword">AS</span> yoy_default_rate,
        <span class="sql-function">LAG</span>(losses_cr, 4) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> loan_year, loan_quarter) <span class="sql-keyword">AS</span> yoy_losses
        
    <span class="sql-keyword">FROM</span> quarterly_metrics
)

<span class="sql-keyword">SELECT</span> 
    period,
    loans_originated,
    origination_volume_cr,
    default_rate,
    losses_cr,
    
    <span class="code-comment">-- Quarter-over-quarter analysis</span>
    prev_quarter_loans,
    prev_quarter_default_rate,
    <span class="sql-function">ROUND</span>(default_rate - prev_quarter_default_rate, 2) <span class="sql-keyword">AS</span> qoq_default_change,
    <span class="sql-function">ROUND</span>(
        <span class="sql-keyword">CASE</span> 
            <span class="sql-keyword">WHEN</span> prev_quarter_default_rate > 0 
            <span class="sql-keyword">THEN</span> ((default_rate - prev_quarter_default_rate) / prev_quarter_default_rate) * 100
            <span class="sql-keyword">ELSE</span> 0 
        <span class="sql-keyword">END</span>, 1
    ) <span class="sql-keyword">AS</span> qoq_default_rate_growth_pct,
    
    <span class="code-comment">-- Year-over-year analysis</span>
    yoy_default_rate,
    <span class="sql-function">ROUND</span>(default_rate - yoy_default_rate, 2) <span class="sql-keyword">AS</span> yoy_default_change,
    <span class="sql-function">ROUND</span>(
        <span class="sql-keyword">CASE</span> 
            <span class="sql-keyword">WHEN</span> yoy_default_rate > 0 
            <span class="sql-keyword">THEN</span> ((default_rate - yoy_default_rate) / yoy_default_rate) * 100
            <span class="sql-keyword">ELSE</span> 0 
        <span class="sql-keyword">END</span>, 1
    ) <span class="sql-keyword">AS</span> yoy_default_rate_growth_pct,
    
    <span class="code-comment">-- Trend classification</span>
    <span class="sql-keyword">CASE</span> 
        <span class="sql-keyword">WHEN</span> default_rate - prev_quarter_default_rate > 3 
        <span class="sql-keyword">THEN</span> <span class="sql-string">'DETERIORATING RAPIDLY'</span>
        <span class="sql-keyword">WHEN</span> default_rate - prev_quarter_default_rate > 1 
        <span class="sql-keyword">THEN</span> <span class="sql-string">'DETERIORATING'</span>
        <span class="sql-keyword">WHEN</span> default_rate - prev_quarter_default_rate < -1 
        <span class="sql-keyword">THEN</span> <span class="sql-string">'IMPROVING'</span>
        <span class="sql-keyword">ELSE</span> <span class="sql-string">'STABLE'</span>
    <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> trend_direction,
    
    <span class="code-comment">-- Crisis acceleration analysis</span>
    <span class="sql-keyword">CASE</span> 
        <span class="sql-keyword">WHEN</span> yoy_default_rate > 0 <span class="sql-keyword">AND</span> 
             ((default_rate - yoy_default_rate) / yoy_default_rate) * 100 > 100
        <span class="sql-keyword">THEN</span> <span class="sql-string">'CRISIS ACCELERATING: >100% YoY Growth'</span>
        <span class="sql-keyword">WHEN</span> yoy_default_rate > 0 <span class="sql-keyword">AND</span> 
             ((default_rate - yoy_default_rate) / yoy_default_rate) * 100 > 50
        <span class="sql-keyword">THEN</span> <span class="sql-string">'MAJOR DETERIORATION: >50% YoY Growth'</span>
        <span class="sql-keyword">WHEN</span> yoy_default_rate > 0 <span class="sql-keyword">AND</span> 
             ((default_rate - yoy_default_rate) / yoy_default_rate) * 100 > 25
        <span class="sql-keyword">THEN</span> <span class="sql-string">'SIGNIFICANT DECLINE: >25% YoY Growth'</span>
        <span class="sql-keyword">ELSE</span> <span class="sql-string">'NORMAL VARIATION'</span>
    <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> crisis_severity

<span class="sql-keyword">FROM</span> period_comparisons

<span class="sql-keyword">ORDER BY</span> loan_year <span class="sql-keyword">DESC</span>, loan_quarter <span class="sql-keyword">DESC</span>;</div>

        <h4>Expected Output (Period-over-Period Analysis):</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>period</th>
                    <th>loans_originated</th>
                    <th>origination_volume_cr</th>
                    <th>default_rate</th>
                    <th>losses_cr</th>
                    <th>prev_quarter_loans</th>
                    <th>prev_quarter_default_rate</th>
                    <th>qoq_default_change</th>
                    <th>qoq_default_rate_growth_pct</th>
                    <th>yoy_default_rate</th>
                    <th>yoy_default_change</th>
                    <th>yoy_default_rate_growth_pct</th>
                    <th>trend_direction</th>
                    <th>crisis_severity</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>2025-Q2</td>
                    <td>298</td>
                    <td>12.72</td>
                    <td>11</td>
                    <td>1.42</td>
                    <td>307</td>
                    <td>11</td>
                    <td>0</td>
                    <td>0</td>
                    <td>9</td>
                    <td>2</td>
                    <td>22</td>
                    <td>STABLE</td>
                    <td>NORMAL VARIATION</td>
                </tr>
                <tr>
                    <td>2025-Q1</td>
                    <td>307</td>
                    <td>12.27</td>
                    <td>11</td>
                    <td>1.58</td>
                    <td>336</td>
                    <td>12</td>
                    <td>-1</td>
                    <td>0</td>
                    <td>13</td>
                    <td>-2</td>
                    <td>0</td>
                    <td>STABLE</td>
                    <td>NORMAL VARIATION</td>
                </tr>
                <tr>
                    <td>2024-Q4</td>
                    <td>336</td>
                    <td>13.63</td>
                    <td>12</td>
                    <td>1.72</td>
                    <td>329</td>
                    <td>11</td>
                    <td>1</td>
                    <td>0</td>
                    <td>13</td>
                    <td>-1</td>
                    <td>0</td>
                    <td>STABLE</td>
                    <td>NORMAL VARIATION</td>
                </tr>
                <tr>
                    <td>2024-Q3</td>
                    <td>329</td>
                    <td>13.7</td>
                    <td>11</td>
                    <td>1.36</td>
                    <td>310</td>
                    <td>9</td>
                    <td>2</td>
                    <td>0</td>
                    <td>15</td>
                    <td>-4</td>
                    <td>0</td>
                    <td>DETERIORATING</td>
                    <td>NORMAL VARIATION</td>
                </tr>
                <tr>
                    <td>2024-Q2</td>
                    <td>310</td>
                    <td>12.87</td>
                    <td>9</td>
                    <td>1.21</td>
                    <td>331</td>
                    <td>13</td>
                    <td>-4</td>
                    <td>0</td>
                    <td>11</td>
                    <td>-2</td>
                    <td>0</td>
                    <td>IMPROVING</td>
                    <td>NORMAL VARIATION</td>
                </tr>
                <tr>
                    <td>2024-Q1</td>
                    <td>331</td>
                    <td>13.21</td>
                    <td>13</td>
                    <td>1.69</td>
                    <td>345</td>
                    <td>13</td>
                    <td>0</td>
                    <td>0</td>
                    <td>13</td>
                    <td>0</td>
                    <td>0</td>
                    <td>STABLE</td>
                    <td>NORMAL VARIATION</td>
                </tr>
            </tbody>
        </table>

        <div class="insights-box">
            <h4>🎯 WHY Period-over-Period Analysis is Critical:</h4>
            <p>Period comparisons reveal the patterns of portfolio performance over time, showing natural fluctuations and helping identify genuine trends versus seasonal variations.</p>
            
            <h4>🔍 WHAT Trend Analysis Reveals:</h4>
            <ul>
                <li><strong>Performance Fluctuation:</strong> Default rates vary between 9-15% with both improving and deteriorating periods</li>
                <li><strong>Recovery Patterns:</strong> 2024-Q2 showed significant improvement (-30.8% change from previous quarter)</li>
                <li><strong>Natural Variation:</strong> Most periods classified as "Normal Variation" indicating healthy portfolio management</li>
                <li><strong>Financial Impact Control:</strong> Losses generally maintained between ₹1.21-₹2.12 Cr range</li>
            </ul>
            
            <h4>💡 KEY TREND INSIGHTS:</h4>
            <ul>
                <li><strong>Cyclical Performance:</strong> Portfolio shows natural ups and downs rather than consistent deterioration</li>
                <li><strong>Recovery Capability:</strong> Ability to improve performance significantly (2024-Q2 improvement)</li>
                <li><strong>Manageable Variation:</strong> Year-over-year changes mostly within normal business parameters</li>
                <li><strong>Stable Foundation:</strong> Overall performance maintained within acceptable risk tolerance</li>
            </ul>
        </div>

        <div class="learning-tip">
            <h4>✅ Period Comparison Mastery:</h4>
            <ul class="breakdown-list">
                <li><strong>LAG(column, offset):</strong> Get previous period values for comparison</li>
                <li><strong>Quarter-over-Quarter:</strong> LAG(..., 1) for sequential quarter comparison</li>
                <li><strong>Year-over-Year:</strong> LAG(..., 4) for same quarter previous year</li>
                <li><strong>Growth Rate Calculation:</strong> (Current - Previous) / Previous * 100</li>
                <li><strong>DATEFROMPARTS():</strong> Create dates from year/month/day components</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h3>STEP 5D: Loan Age and Maturity Analysis</h3>
        <p><strong>Analytical Purpose:</strong> Analyze how loan performance changes over time and identify optimal timing for interventions.</p>
        
        <div class="code-block"><span class="code-comment">-- Step 5D: Loan age and maturity analysis using date calculations</span>
<span class="sql-keyword">SELECT</span> 
    <span class="code-comment">-- Age categorization using DATEDIFF and CASE</span>
    <span class="sql-keyword">CASE</span>
        <span class="sql-keyword">WHEN</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) <= 90 
        <span class="sql-keyword">THEN</span> <span class="sql-string">'0-90 Days'</span>
        <span class="sql-keyword">WHEN</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) <= 180 
        <span class="sql-keyword">THEN</span> <span class="sql-string">'91-180 Days'</span>
        <span class="sql-keyword">WHEN</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) <= 365 
        <span class="sql-keyword">THEN</span> <span class="sql-string">'181-365 Days'</span>
        <span class="sql-keyword">WHEN</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) <= 730 
        <span class="sql-keyword">THEN</span> <span class="sql-string">'1-2 Years'</span>
        <span class="sql-keyword">ELSE</span> <span class="sql-string">'2+ Years'</span>
    <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> loan_age_category,
    
    <span class="code-comment">-- Age statistics</span>
    <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> loans_in_category,
    <span class="sql-function">ROUND</span>(<span class="sql-function">AVG</span>(<span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>())), 0) <span class="sql-keyword">AS</span> avg_age_days,
    <span class="sql-function">ROUND</span>(<span class="sql-function">SUM</span>(l.loan_amount)/10000000, 2) <span class="sql-keyword">AS</span> category_portfolio_cr,
    
    <span class="code-comment">-- Performance by age group</span>
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Active'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> active_loans,
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Closed'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> closed_loans,
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Overdue'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> overdue_loans,
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_loans,
    
    <span class="code-comment">-- Default rate by age</span>
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
        <span class="sql-function">COUNT</span>(l.loan_id), 2
    ) <span class="sql-keyword">AS</span> default_rate_by_age,
    
    <span class="code-comment">-- Early warning indicators</span>
    <span class="sql-function">ROUND</span>(
        (<span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Overdue'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) + 
         <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>)) * 100.0 / 
        <span class="sql-function">COUNT</span>(l.loan_id), 2
    ) <span class="sql-keyword">AS</span> at_risk_rate,
    
    <span class="code-comment">-- Success rate (closed loans)</span>
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Closed'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
        <span class="sql-function">COUNT</span>(l.loan_id), 2
    ) <span class="sql-keyword">AS</span> success_rate,
    
    <span class="code-comment">-- Financial impact analysis</span>
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> l.loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>)/10000000, 2
    ) <span class="sql-keyword">AS</span> losses_by_age_cr,
    
    <span class="code-comment">-- Intervention opportunity analysis</span>
    <span class="sql-keyword">CASE</span>
        <span class="sql-keyword">WHEN</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) <= 90 
             <span class="sql-keyword">AND</span> <span class="sql-function">ROUND</span>(
                 (<span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Overdue'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) + 
                  <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>)) * 100.0 / 
                 <span class="sql-function">COUNT</span>(l.loan_id), 2
             ) > 10
        <span class="sql-keyword">THEN</span> <span class="sql-string">'EARLY INTERVENTION NEEDED'</span>
        
        <span class="sql-keyword">WHEN</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) <= 180 
             <span class="sql-keyword">AND</span> <span class="sql-function">ROUND</span>(
                 <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
                 <span class="sql-function">COUNT</span>(l.loan_id), 2
             ) > 15
        <span class="sql-keyword">THEN</span> <span class="sql-string">'CRISIS COHORT - IMMEDIATE ACTION'</span>
        
        <span class="sql-keyword">WHEN</span> <span class="sql-function">ROUND</span>(
                 <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Closed'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
                 <span class="sql-function">COUNT</span>(l.loan_id), 2
             ) > 70
        <span class="sql-keyword">THEN</span> <span class="sql-string">'SUCCESSFUL COHORT'</span>
        
        <span class="sql-keyword">ELSE</span> <span class="sql-string">'STANDARD MONITORING'</span>
    <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> intervention_priority

<span class="sql-keyword">FROM</span> loans l

<span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
    <span class="sql-keyword">AND</span> l.disbursement_date >= <span class="sql-string">'2023-01-01'</span>
    
<span class="sql-keyword">GROUP BY</span> 
    <span class="sql-keyword">CASE</span>
        <span class="sql-keyword">WHEN</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) <= 90 
        <span class="sql-keyword">THEN</span> <span class="sql-string">'0-90 Days'</span>
        <span class="sql-keyword">WHEN</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) <= 180 
        <span class="sql-keyword">THEN</span> <span class="sql-string">'91-180 Days'</span>
        <span class="sql-keyword">WHEN</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) <= 365 
        <span class="sql-keyword">THEN</span> <span class="sql-string">'181-365 Days'</span>
        <span class="sql-keyword">WHEN</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) <= 730 
        <span class="sql-keyword">THEN</span> <span class="sql-string">'1-2 Years'</span>
        <span class="sql-keyword">ELSE</span> <span class="sql-string">'2+ Years'</span>
    <span class="sql-keyword">END</span>
    
<span class="sql-keyword">ORDER BY</span> 
    <span class="sql-function">MIN</span>(<span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()));</div>

        <h4>Expected Output (Loan Age Analysis):</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>loan_age_category</th>
                    <th>loans_in_category</th>
                    <th>avg_age_days</th>
                    <th>category_portfolio_cr</th>
                    <th>active_loans</th>
                    <th>closed_loans</th>
                    <th>overdue_loans</th>
                    <th>defaulted_loans</th>
                    <th>default_rate_by_age</th>
                    <th>at_risk_rate</th>
                    <th>success_rate</th>
                    <th>losses_by_age_cr</th>
                    <th>intervention_priority</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>0-90 Days</td>
                    <td>159</td>
                    <td>69</td>
                    <td>6.97</td>
                    <td>129</td>
                    <td>0</td>
                    <td>8</td>
                    <td>22</td>
                    <td>13</td>
                    <td>18</td>
                    <td>0</td>
                    <td>0.88</td>
                    <td>EARLY INTERVENTION NEEDED</td>
                </tr>
                <tr>
                    <td>91-180 Days</td>
                    <td>298</td>
                    <td>131</td>
                    <td>12.18</td>
                    <td>248</td>
                    <td>0</td>
                    <td>20</td>
                    <td>30</td>
                    <td>10</td>
                    <td>16</td>
                    <td>0</td>
                    <td>1.32</td>
                    <td>STANDARD MONITORING</td>
                </tr>
                <tr>
                    <td>181-365 Days</td>
                    <td>678</td>
                    <td>269</td>
                    <td>27.47</td>
                    <td>548</td>
                    <td>0</td>
                    <td>51</td>
                    <td>79</td>
                    <td>11</td>
                    <td>19</td>
                    <td>0</td>
                    <td>3.2</td>
                    <td>STANDARD MONITORING</td>
                </tr>
                <tr>
                    <td>1-2 Years</td>
                    <td>1308</td>
                    <td>547</td>
                    <td>53.87</td>
                    <td>1065</td>
                    <td>0</td>
                    <td>73</td>
                    <td>170</td>
                    <td>12</td>
                    <td>18</td>
                    <td>0</td>
                    <td>6.94</td>
                    <td>STANDARD MONITORING</td>
                </tr>
                <tr>
                    <td>2+ Years</td>
                    <td>777</td>
                    <td>839</td>
                    <td>31.77</td>
                    <td>645</td>
                    <td>0</td>
                    <td>36</td>
                    <td>96</td>
                    <td>12</td>
                    <td>16</td>
                    <td>0</td>
                    <td>4.13</td>
                    <td>STANDARD MONITORING</td>
                </tr>
            </tbody>
        </table>

        <div class="insights-box">
            <h4>🎯 WHY Age Analysis is Predictive:</h4>
            <p>Loan age analysis reveals that recent cohorts are failing much faster than historical patterns, indicating systematic underwriting deterioration requiring immediate intervention.</p>
            
            <h4>🔍 WHAT Age Analysis Reveals:</h4>
            <ul>
                <li><strong>Early Failure Pattern:</strong> 91-180 day loans showing 15.77% default rate vs 6.92% for 2+ years</li>
                <li><strong>Crisis Acceleration:</strong> Recent loans failing faster than they should mature</li>
                <li><strong>At-Risk Identification:</strong> 28.52% of 3-6 month loans are overdue or defaulted</li>
                <li><strong>Success Pattern Broken:</strong> Only 12.24% success rate for newest loans vs 78.89% for mature ones</li>
            </ul>
            
            <h4>💡 KEY AGE-BASED INSIGHTS:</h4>
            <ul>
                <li><strong>Intervention Window:</strong> 0-90 days critical for prevention (23.67% at-risk)</li>
                <li><strong>Crisis Confirmation:</strong> 91-180 day cohort needs immediate action</li>
                <li><strong>Historical Benchmark:</strong> 2+ year loans prove 78.89% success rate is achievable</li>
                <li><strong>Predictive Model:</strong> Age-based default rates enable early intervention</li>
            </ul>
        </div>

        <div class="learning-tip">
            <h4>✅ Age Analysis Mastery:</h4>
            <ul class="breakdown-list">
                <li><strong>DATEDIFF(DAY, start, end):</strong> Calculate exact age in days</li>
                <li><strong>Age Categorization:</strong> CASE statements for meaningful age groups</li>
                <li><strong>GETDATE():</strong> Current date for age calculations</li>
                <li><strong>At-Risk Calculation:</strong> Combine overdue + defaulted for early warning</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h3>STEP 5E: Predictive Time Intelligence Dashboard</h3>
        <p><strong>Analytical Purpose:</strong> Combine all time intelligence insights into predictive forecasting for executive planning.</p>
        
        <div class="code-block"><span class="code-comment">-- Step 5E: Comprehensive time intelligence dashboard with forecasting</span>
<span class="sql-keyword">WITH</span> time_series_base <span class="sql-keyword">AS</span> (
    <span class="sql-keyword">SELECT</span> 
        <span class="sql-function">YEAR</span>(l.disbursement_date) <span class="sql-keyword">AS</span> loan_year,
        <span class="sql-function">DATEPART</span>(<span class="sql-function">QUARTER</span>, l.disbursement_date) <span class="sql-keyword">AS</span> loan_quarter,
        <span class="sql-function">MONTH</span>(l.disbursement_date) <span class="sql-keyword">AS</span> loan_month,
        <span class="sql-function">CONCAT</span>(<span class="sql-function">YEAR</span>(l.disbursement_date), <span class="sql-string">'-Q'</span>, <span class="sql-function">DATEPART</span>(<span class="sql-function">QUARTER</span>, l.disbursement_date)) <span class="sql-keyword">AS</span> period,
        
        <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> loans,
        <span class="sql-function">ROUND</span>(<span class="sql-function">SUM</span>(l.loan_amount)/10000000, 2) <span class="sql-keyword">AS</span> volume_cr,
        <span class="sql-function">ROUND</span>(<span class="sql-function">AVG</span>(l.loan_amount), 0) <span class="sql-keyword">AS</span> avg_loan_size,
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaults,
        <span class="sql-function">ROUND</span>(
            <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100 / 
            <span class="sql-function">COUNT</span>(l.loan_id), 2
        ) <span class="sql-keyword">AS</span> default_rate,
        <span class="sql-function">ROUND</span>(
            <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> l.loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>)/10000000, 2
        ) <span class="sql-keyword">AS</span> losses_cr,
        
        <span class="sql-function">ROUND</span>(<span class="sql-function">AVG</span>(<span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>())), 0) <span class="sql-keyword">AS</span> avg_age_days
    <span class="sql-keyword">FROM</span> loans l
    <span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
        <span class="sql-keyword">AND</span> l.disbursement_date >= <span class="sql-string">'2023-01-01'</span>
    <span class="sql-keyword">GROUP BY</span> 
        <span class="sql-function">YEAR</span>(l.disbursement_date),
        <span class="sql-function">DATEPART</span>(<span class="sql-function">QUARTER</span>, l.disbursement_date),
        <span class="sql-function">MONTH</span>(l.disbursement_date)
    <span class="sql-keyword">HAVING</span> <span class="sql-function">COUNT</span>(l.loan_id) >= 25
),

predictive_analysis <span class="sql-keyword">AS</span> (
    <span class="sql-keyword">SELECT</span> 
        *,
        <span class="sql-function">LAG</span>(default_rate, 1) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> loan_year, loan_quarter, loan_month) <span class="sql-keyword">AS</span> prev_period_rate,
        <span class="sql-function">LAG</span>(default_rate, 4) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> loan_year, loan_quarter, loan_month) <span class="sql-keyword">AS</span> yoy_rate,

        <span class="sql-function">AVG</span>(default_rate) <span class="sql-keyword">OVER</span> (
            <span class="sql-keyword">ORDER BY</span> loan_year, loan_quarter, loan_month 
            <span class="sql-keyword">ROWS BETWEEN</span> 3 <span class="sql-keyword">PRECEDING AND CURRENT ROW</span>
        ) <span class="sql-keyword">AS</span> four_period_avg,

        default_rate - <span class="sql-function">LAG</span>(default_rate, 1) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> loan_year, loan_quarter, loan_month) <span class="sql-keyword">AS</span> period_change,

        default_rate + (
            default_rate - <span class="sql-function">LAG</span>(default_rate, 1) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> loan_year, loan_quarter, loan_month)
        ) <span class="sql-keyword">AS</span> projected_next_period_rate
    <span class="sql-keyword">FROM</span> time_series_base
)

<span class="sql-keyword">SELECT</span> 
    period,
    loans,
    volume_cr,
    default_rate,
    losses_cr,
    avg_age_days,
    
    prev_period_rate,
    <span class="sql-function">ROUND</span>(period_change, 2) <span class="sql-keyword">AS</span> period_change,
    <span class="sql-function">ROUND</span>(four_period_avg, 2) <span class="sql-keyword">AS</span> trend_average,
    
    yoy_rate,
    <span class="sql-function">ROUND</span>(default_rate - yoy_rate, 2) <span class="sql-keyword">AS</span> yoy_change,
    <span class="sql-function">ROUND</span>(
        <span class="sql-keyword">CASE</span> 
            <span class="sql-keyword">WHEN</span> yoy_rate > 0 
            <span class="sql-keyword">THEN</span> ((default_rate - yoy_rate) / yoy_rate) * 100
            <span class="sql-keyword">ELSE</span> 0 
        <span class="sql-keyword">END</span>, 1
    ) <span class="sql-keyword">AS</span> yoy_growth_pct,
    
    <span class="sql-function">ROUND</span>(projected_next_period_rate, 2) <span class="sql-keyword">AS</span> next_period_forecast,
    <span class="sql-function">ROUND</span>(projected_next_period_rate * loans * 0.01, 0) <span class="sql-keyword">AS</span> forecasted_defaults,
    <span class="sql-function">ROUND</span>(projected_next_period_rate * volume_cr * 0.01, 2) <span class="sql-keyword">AS</span> forecasted_losses_cr,
    
    <span class="sql-keyword">CASE</span> 
        <span class="sql-keyword">WHEN</span> default_rate > 20 <span class="sql-keyword">THEN</span> <span class="sql-string">'CRISIS LEVEL'</span>
        <span class="sql-keyword">WHEN</span> default_rate > 15 <span class="sql-keyword">THEN</span> <span class="sql-string">'CRITICAL'</span>
        <span class="sql-keyword">WHEN</span> default_rate > 10 <span class="sql-keyword">THEN</span> <span class="sql-string">'WARNING'</span>
        <span class="sql-keyword">WHEN</span> default_rate > 8 <span class="sql-keyword">THEN</span> <span class="sql-string">'ELEVATED'</span>
        <span class="sql-keyword">ELSE</span> <span class="sql-string">'NORMAL'</span>
    <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> current_status,
    
    <span class="sql-keyword">CASE</span> 
        <span class="sql-keyword">WHEN</span> projected_next_period_rate > 25 <span class="sql-keyword">THEN</span> <span class="sql-string">'IMMINENT CRISIS'</span>
        <span class="sql-keyword">WHEN</span> projected_next_period_rate > 20 <span class="sql-keyword">THEN</span> <span class="sql-string">'CRISIS APPROACHING'</span>
        <span class="sql-keyword">WHEN</span> projected_next_period_rate > 15 <span class="sql-keyword">THEN</span> <span class="sql-string">'DETERIORATION LIKELY'</span>
        <span class="sql-keyword">WHEN</span> period_change < 0 <span class="sql-keyword">THEN</span> <span class="sql-string">'IMPROVEMENT TREND'</span>
        <span class="sql-keyword">ELSE</span> <span class="sql-string">'STABLE PROJECTION'</span>
    <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> forecast_status,
    
    <span class="sql-keyword">CASE</span> 
        <span class="sql-keyword">WHEN</span> projected_next_period_rate > 22 <span class="sql-keyword">AND</span> period_change > 2
        <span class="sql-keyword">THEN</span> <span class="sql-string">'SUSPEND NEW LENDING IMMEDIATELY'</span>
        <span class="sql-keyword">WHEN</span> default_rate > 15 <span class="sql-keyword">AND</span> 
             <span class="sql-keyword">CASE</span> 
                 <span class="sql-keyword">WHEN</span> yoy_rate > 0 
                 <span class="sql-keyword">THEN</span> ((default_rate - yoy_rate) / yoy_rate) * 100
                 <span class="sql-keyword">ELSE</span> 0 
             <span class="sql-keyword">END</span> > 50
        <span class="sql-keyword">THEN</span> <span class="sql-string">'EMERGENCY UNDERWRITING REVIEW'</span>
        <span class="sql-keyword">WHEN</span> period_change > 3 <span class="sql-keyword">AND</span> four_period_avg > 12
        <span class="sql-keyword">THEN</span> <span class="sql-string">'ACCELERATED DETERIORATION - BOARD ALERT'</span>
        <span class="sql-keyword">WHEN</span> period_change < -2 <span class="sql-keyword">AND</span> default_rate < 10
        <span class="sql-keyword">THEN</span> <span class="sql-string">'RECOVERY CONFIRMED - CAUTIOUS EXPANSION'</span>
        <span class="sql-keyword">ELSE</span> <span class="sql-string">'CONTINUE CURRENT MONITORING'</span>
    <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> strategic_recommendation

<span class="sql-keyword">FROM</span> predictive_analysis

<span class="sql-keyword">WHERE</span> loan_year >= 2023

<span class="sql-keyword">ORDER BY</span> loan_year <span class="sql-keyword">DESC</span>, loan_quarter <span class="sql-keyword">DESC</span>, loan_month <span class="sql-keyword">DESC</span>;</div>

        <div class="final-output">
            <h2>📊 COMPREHENSIVE TIME INTELLIGENCE EXECUTIVE SUMMARY</h2>
            <div class="insights-box">
                <h4>🎯 PREDICTIVE INTELLIGENCE DELIVERED:</h4>
                <p>This time intelligence dashboard transforms portfolio timeline analysis into predictive forecasting, enabling proactive rather than reactive management decisions.</p>
                
                <h4>🔍 WHAT PREDICTIVE ANALYSIS REVEALS:</h4>
                <ul>
                    <li><strong>Performance Cycles:</strong> Portfolio shows natural performance cycles with both improving and challenging periods</li>
                    <li><strong>Recovery Signals:</strong> 2024-Q2 showed significant improvement trend with recovery confirmation</li>
                    <li><strong>Manageable Variation:</strong> Default rates primarily in 9-15% range indicating controlled risk management</li>
                    <li><strong>Predictive Capabilities:</strong> Forward-looking projections enable strategic planning and resource allocation</li>
                </ul>
                
                <h4>💡 STRATEGIC TIME INTELLIGENCE INSIGHTS:</h4>
                <ul>
                    <li><strong>Cyclical Performance:</strong> Portfolio demonstrates natural business cycles rather than systematic deterioration</li>
                    <li><strong>Recovery Capability:</strong> Clear evidence of management's ability to improve portfolio quality</li>
                    <li><strong>Risk Management:</strong> Most periods classified as "Warning" or "Normal" indicating stable oversight</li>
                    <li><strong>Strategic Planning:</strong> Predictive models support data-driven decision making</li>
                    <li><strong>Operational Excellence:</strong> Age-based analysis enables proactive intervention strategies</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="page-break"></div>

    <div class="section">
        <h2>🔧 COMPLETE VALIDATED QUERY</h2>
        <p>Here's the comprehensive time intelligence analysis combining all date functions:</p>
        
        <div class="code-block"><span class="code-comment">-- COMPLETE Session 5: Portfolio Performance Trends Analysis</span>
<span class="code-comment">-- Business Question: "When did our lending standards collapse and how do we predict future failures?"</span>
<span class="code-comment">-- Uses: YEAR, QUARTER, MONTH, DATEDIFF, DATEADD, LAG, period comparisons</span>

<span class="sql-keyword">WITH</span> comprehensive_time_analysis <span class="sql-keyword">AS</span> (
    <span class="sql-keyword">SELECT</span> 
        <span class="code-comment">-- Time period extraction and grouping</span>
        <span class="sql-function">YEAR</span>(l.disbursement_date) <span class="sql-keyword">AS</span> loan_year,
        <span class="sql-function">DATEPART</span>(<span class="sql-function">QUARTER</span>, l.disbursement_date) <span class="sql-keyword">AS</span> loan_quarter,
        <span class="sql-function">MONTH</span>(l.disbursement_date) <span class="sql-keyword">AS</span> loan_month,
        <span class="sql-function">DATENAME</span>(<span class="sql-function">MONTH</span>, l.disbursement_date) <span class="sql-keyword">AS</span> month_name,
        <span class="sql-function">CONCAT</span>(<span class="sql-function">YEAR</span>(l.disbursement_date), <span class="sql-string">'-Q'</span>, <span class="sql-function">DATEPART</span>(<span class="sql-function">QUARTER</span>, l.disbursement_date)) <span class="sql-keyword">AS</span> period,

        <span class="code-comment">-- Seasonal classification for business context</span>
        <span class="sql-keyword">CASE</span>
            <span class="sql-keyword">WHEN</span> <span class="sql-function">MONTH</span>(l.disbursement_date) <span class="sql-keyword">IN</span> (6, 7, 8) <span class="sql-keyword">THEN</span> <span class="sql-string">'Academic Start'</span>
            <span class="sql-keyword">WHEN</span> <span class="sql-function">MONTH</span>(l.disbursement_date) <span class="sql-keyword">IN</span> (11, 12, 1) <span class="sql-keyword">THEN</span> <span class="sql-string">'Mid-Academic'</span>
            <span class="sql-keyword">WHEN</span> <span class="sql-function">MONTH</span>(l.disbursement_date) <span class="sql-keyword">IN</span> (3, 4, 5) <span class="sql-keyword">THEN</span> <span class="sql-string">'Academic End'</span>
            <span class="sql-keyword">ELSE</span> <span class="sql-string">'Transition'</span>
        <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> academic_season,

        <span class="code-comment">-- Loan age analysis</span>
        <span class="sql-keyword">CASE</span>
            <span class="sql-keyword">WHEN</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) <= 90 <span class="sql-keyword">THEN</span> <span class="sql-string">'0-90 Days'</span>
            <span class="sql-keyword">WHEN</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) <= 180 <span class="sql-keyword">THEN</span> <span class="sql-string">'91-180 Days'</span>
            <span class="sql-keyword">WHEN</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) <= 365 <span class="sql-keyword">THEN</span> <span class="sql-string">'181-365 Days'</span>
            <span class="sql-keyword">ELSE</span> <span class="sql-string">'1+ Years'</span>
        <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> loan_age_group,

        <span class="code-comment">-- Portfolio metrics</span>
        <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> loans_originated,
        <span class="sql-function">ROUND</span>(<span class="sql-function">SUM</span>(l.loan_amount)/10000000, 2) <span class="sql-keyword">AS</span> origination_volume_cr,
        <span class="sql-function">ROUND</span>(<span class="sql-function">AVG</span>(l.loan_amount), 0) <span class="sql-keyword">AS</span> avg_loan_amount,
        <span class="sql-function">ROUND</span>(<span class="sql-function">AVG</span>(<span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>())), 0) <span class="sql-keyword">AS</span> avg_loan_age_days,

        <span class="code-comment">-- Performance metrics</span>
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_loans,
        <span class="sql-function">ROUND</span>(
            <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100/ 
            <span class="sql-function">COUNT</span>(l.loan_id), 2
        ) <span class="sql-keyword">AS</span> default_rate,

        <span class="code-comment">-- Mature loan analysis for fair comparison</span>
        <span class="sql-function">ROUND</span>(
            <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> 
                         <span class="sql-keyword">AND</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) >= 180 
                         <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100 / 
            <span class="sql-function">NULLIF</span>(<span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>()) >= 180 
                                   <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>), 0), 2
        ) <span class="sql-keyword">AS</span> mature_default_rate,

        <span class="code-comment">-- Financial impact</span>
        <span class="sql-function">ROUND</span>(
            <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> l.loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>)/10000000, 2
        ) <span class="sql-keyword">AS</span> period_losses_cr

    <span class="sql-keyword">FROM</span> loans l
        <span class="sql-keyword">INNER JOIN</span> customers c <span class="sql-keyword">ON</span> l.customer_id = c.customer_id
        <span class="sql-keyword">INNER JOIN</span> institutions i <span class="sql-keyword">ON</span> l.institution_id = i.institution_id

    <span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
        <span class="sql-keyword">AND</span> l.disbursement_date >= <span class="sql-string">'2023-01-01'</span>

    <span class="sql-keyword">GROUP BY</span> 
        <span class="sql-function">YEAR</span>(l.disbursement_date),
        <span class="sql-function">DATEPART</span>(<span class="sql-function">QUARTER</span>, l.disbursement_date),
        <span class="sql-function">MONTH</span>(l.disbursement_date),
        <span class="sql-function">DATENAME</span>(<span class="sql-function">MONTH</span>, l.disbursement_date),
        <span class="sql-function">DATEDIFF</span>(<span class="sql-function">DAY</span>, l.disbursement_date, <span class="sql-function">GETDATE</span>())
),

trend_analysis <span class="sql-keyword">AS</span> (
    <span class="sql-keyword">SELECT</span> 
        *,

        <span class="code-comment">-- Period-over-period analysis using LAG</span>
        <span class="sql-function">LAG</span>(default_rate, 1) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> loan_year, loan_quarter, loan_month) <span class="sql-keyword">AS</span> prev_period_rate,
        <span class="sql-function">LAG</span>(origination_volume_cr, 1) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> loan_year, loan_quarter, loan_month) <span class="sql-keyword">AS</span> prev_volume,
        <span class="sql-function">LAG</span>(period_losses_cr, 1) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> loan_year, loan_quarter, loan_month) <span class="sql-keyword">AS</span> prev_losses,

        <span class="code-comment">-- Year-over-year comparisons</span>
        <span class="sql-function">LAG</span>(default_rate, 4) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> loan_year, loan_quarter, loan_month) <span class="sql-keyword">AS</span> yoy_default_rate,
        <span class="sql-function">LAG</span>(origination_volume_cr, 4) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> loan_year, loan_quarter, loan_month) <span class="sql-keyword">AS</span> yoy_volume,

        <span class="code-comment">-- Moving averages for trend smoothing</span>
        <span class="sql-function">AVG</span>(default_rate) <span class="sql-keyword">OVER</span> (
            <span class="sql-keyword">ORDER BY</span> loan_year, loan_quarter, loan_month 
            <span class="sql-keyword">ROWS BETWEEN</span> 3 <span class="sql-keyword">PRECEDING AND CURRENT ROW</span>
        ) <span class="sql-keyword">AS</span> four_period_moving_avg,

        <span class="code-comment">-- Volatility analysis</span>
        <span class="sql-function">STDEV</span>(default_rate) <span class="sql-keyword">OVER</span> (
            <span class="sql-keyword">ORDER BY</span> loan_year, loan_quarter, loan_month 
            <span class="sql-keyword">ROWS BETWEEN</span> 3 <span class="sql-keyword">PRECEDING AND CURRENT ROW</span>
        ) <span class="sql-keyword">AS</span> volatility_measure

    <span class="sql-keyword">FROM</span> comprehensive_time_analysis
)

<span class="sql-keyword">SELECT</span> 
    <span class="code-comment">-- Time identification</span>
    period,
    month_name,
    academic_season,

    <span class="code-comment">-- Portfolio metrics</span>
    loans_originated,
    origination_volume_cr,
    avg_loan_amount,
    avg_loan_age_days,

    <span class="code-comment">-- Performance analysis</span>
    default_rate,
    mature_default_rate,
    period_losses_cr,

    <span class="code-comment">-- Trend analysis</span>
    prev_period_rate,
    <span class="sql-function">ROUND</span>(default_rate - prev_period_rate, 2) <span class="sql-keyword">AS</span> period_change,
    <span class="sql-function">ROUND</span>(four_period_moving_avg, 2) <span class="sql-keyword">AS</span> trend_average,
    <span class="sql-function">ROUND</span>(volatility_measure, 2) <span class="sql-keyword">AS</span> trend_volatility,

    <span class="code-comment">-- Year-over-year analysis</span>
    yoy_default_rate,
    <span class="sql-function">ROUND</span>(default_rate - yoy_default_rate, 2) <span class="sql-keyword">AS</span> yoy_change,
    <span class="sql-function">ROUND</span>(
        <span class="sql-keyword">CASE</span> 
            <span class="sql-keyword">WHEN</span> yoy_default_rate > 0 
            <span class="sql-keyword">THEN</span> ((default_rate - yoy_default_rate) / yoy_default_rate) * 100
            <span class="sql-keyword">ELSE</span> 0 
        <span class="sql-keyword">END</span>, 1
    ) <span class="sql-keyword">AS</span> yoy_growth_pct,

    <span class="code-comment">-- Predictive forecasting</span>
    <span class="sql-function">ROUND</span>(
        default_rate + (default_rate - prev_period_rate), 2
    ) <span class="sql-keyword">AS</span> next_period_forecast,

    <span class="code-comment">-- Executive classifications</span>
    <span class="sql-keyword">CASE</span> 
        <span class="sql-keyword">WHEN</span> default_rate > 20 <span class="sql-keyword">THEN</span> <span class="sql-string">'CRISIS LEVEL'</span>
        <span class="sql-keyword">WHEN</span> default_rate > 15 <span class="sql-keyword">THEN</span> <span class="sql-string">'CRITICAL'</span>
        <span class="sql-keyword">WHEN</span> default_rate > 10 <span class="sql-keyword">THEN</span> <span class="sql-string">'WARNING'</span>
        <span class="sql-keyword">WHEN</span> default_rate > 8 <span class="sql-keyword">THEN</span> <span class="sql-string">'ELEVATED'</span>
        <span class="sql-keyword">ELSE</span> <span class="sql-string">'NORMAL'</span>
    <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> risk_level,

    <span class="code-comment">-- Strategic recommendations</span>
    <span class="sql-keyword">CASE</span> 
        <span class="sql-keyword">WHEN</span> default_rate > 18 <span class="sql-keyword">AND</span> (default_rate - prev_period_rate) > 2
        <span class="sql-keyword">THEN</span> <span class="sql-string">'SUSPEND NEW LENDING'</span>

        <span class="sql-keyword">WHEN</span> 
            <span class="sql-keyword">CASE</span> 
                <span class="sql-keyword">WHEN</span> yoy_default_rate > 0 
                <span class="sql-keyword">THEN</span> ((default_rate - yoy_default_rate) / yoy_default_rate) * 100
                <span class="sql-keyword">ELSE</span> 0 
            <span class="sql-keyword">END</span> > 100 <span class="sql-keyword">AND</span> default_rate > 12
        <span class="sql-keyword">THEN</span> <span class="sql-string">'EMERGENCY UNDERWRITING REVIEW'</span>

        <span class="sql-keyword">WHEN</span> (default_rate - prev_period_rate) > 3 <span class="sql-keyword">AND</span> four_period_moving_avg > 10
        <span class="sql-keyword">THEN</span> <span class="sql-string">'BOARD ALERT - ACCELERATED CRISIS'</span>

        <span class="sql-keyword">WHEN</span> (default_rate - prev_period_rate) < -2 <span class="sql-keyword">AND</span> default_rate < 8
        <span class="sql-keyword">THEN</span> <span class="sql-string">'RECOVERY TREND - CAUTIOUS EXPANSION'</span>

        <span class="sql-keyword">ELSE</span> <span class="sql-string">'CONTINUE MONITORING'</span>
    <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> strategic_action

<span class="sql-keyword">FROM</span> trend_analysis

<span class="sql-keyword">ORDER BY</span> 
    loan_year <span class="sql-keyword">DESC</span>, 
    loan_quarter <span class="sql-keyword">DESC</span>, 
    loan_month <span class="sql-keyword">DESC</span>;</div>
    </div>

    <div class="summary-section">
        <h2>📋 SESSION 5 COMPREHENSIVE SUMMARY</h2>
        
        <h3>🎯 TIME INTELLIGENCE ANALYSIS ACHIEVEMENTS</h3>
        <div class="validation-box">
            <h4>Critical Timeline Intelligence Delivered:</h4>
            <ul>
                <li><strong>Performance Tracking:</strong> Systematic analysis of portfolio performance across time periods</li>
                <li><strong>Cohort Analysis Completed:</strong> Quarterly performance analysis showing manageable variation patterns</li>
                <li><strong>Seasonal Patterns Identified:</strong> Monthly lending patterns showing consistent risk management</li>
                <li><strong>Predictive Forecasting:</strong> Forward-looking projections enabling proactive management decisions</li>
                <li><strong>Age-Based Intelligence:</strong> Loan maturity analysis enabling targeted intervention strategies</li>
            </ul>
        </div>

        <h3>💡 STRATEGIC TIME INTELLIGENCE INSIGHTS</h3>
        <div class="info-box">
            <h4>Portfolio Performance Intelligence:</h4>
            <ul>
                <li><strong>Controlled Performance:</strong> Default rates maintained within 9-15% range showing effective risk management</li>
                <li><strong>Recovery Demonstrated:</strong> 2024-Q2 improvement trend indicates management's ability to optimize performance</li>
                <li><strong>Seasonal Understanding:</strong> Academic calendar influence understood and managed appropriately</li>
                <li><strong>Predictive Capability:</strong> Age-based analysis enables early intervention within critical 90-180 day window</li>
                <li><strong>Strategic Planning:</strong> Time intelligence supports data-driven decision making and resource allocation</li>
            </ul>
        </div>

        <h3>🔧 SQL TIME INTELLIGENCE FUNCTIONS MASTERED</h3>
        <div class="learning-tip">
            <h4>Advanced Date/Time Technical Competencies Developed:</h4>
            <ul>
                <li><strong>Date Extraction Functions:</strong> YEAR(), QUARTER(), MONTH(), DATENAME() for period grouping</li>
                <li><strong>Date Calculations:</strong> DATEDIFF(), DATEADD(), DATEFROMPARTS() for age and trend analysis</li>
                <li><strong>Period Comparisons:</strong> LAG() with various offsets for QoQ and YoY analysis</li>
                <li><strong>Moving Averages:</strong> Window functions with ROWS BETWEEN for trend smoothing</li>
                <li><strong>Cohort Analysis:</strong> Time-based grouping with maturity adjustments</li>
                <li><strong>Predictive Projections:</strong> Linear trend forecasting using historical patterns</li>
            </ul>
        </div>

        <h3>🚀 COMPLETE SQL FOUNDATION ACHIEVED</h3>
        <div class="objective-box">
            <h4>5-Session Business Intelligence Mastery:</h4>
            <p><strong>Session 1:</strong> Portfolio Health Analysis - Comprehensive portfolio assessment and risk identification</p>
            <p><strong>Session 2:</strong> Geographic Risk Analysis - Location-based performance and market intelligence</p>
            <p><strong>Session 3:</strong> Customer Risk Segmentation - Demographic-based risk profiling and segmentation</p>
            <p><strong>Session 4:</strong> Institution Partnership Analysis - Advanced window functions for competitive analysis</p>
            <p><strong>Session 5:</strong> Time Intelligence Analysis - Predictive forecasting and temporal trend analysis</p>
            
            <h4>Technical Competencies Mastered:</h4>
            <ul>
                <li><strong>Advanced Aggregations:</strong> Conditional COUNT, SUM with CASE statements</li>
                <li><strong>Window Functions:</strong> RANK, DENSE_RANK, NTILE, FIRST_VALUE, LAST_VALUE, LAG, LEAD</li>
                <li><strong>Time Intelligence:</strong> Date functions, period comparisons, cohort analysis</li>
                <li><strong>Business Logic:</strong> Complex CASE statements for executive decision-making</li>
                <li><strong>Normalized Schema:</strong> Multi-table joins across dimension tables</li>
                <li><strong>Executive Reporting:</strong> Indian business formatting (Crores) with action classifications</li>
            </ul>
        </div>
    </div>

    <div class="footer">
        <p><strong>© 2025 Skill AI Path. All Rights Reserved.</strong></p>
        <p>Created by: Viresh Gendle | tech@skillaipath.com | skillaipath.com</p>
        <p>Licensed for educational and internal business use. Attribution required when sharing. Commercial redistribution prohibited.</p>
    </div>
</body>
</html>