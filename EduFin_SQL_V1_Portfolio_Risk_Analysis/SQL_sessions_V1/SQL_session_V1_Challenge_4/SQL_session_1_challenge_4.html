<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Session 4: Institution Partnership Performance Analysis</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            line-height: 1.6;
            color: #333;
            background: white;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            page-break-inside: avoid;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .crisis-alert {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .section {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }
        
        .section h2 {
            color: #2c3e50;
            font-size: 1.6em;
            margin-bottom: 15px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 8px;
        }
        
        .section h3 {
            color: #34495e;
            font-size: 1.3em;
            margin: 20px 0 12px 0;
        }
        
        .section h4 {
            color: #2980b9;
            font-size: 1.1em;
            margin: 15px 0 8px 0;
        }
        
        .business-question {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #27ae60;
        }
        
        .objective-box {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            border: 1px solid #4a5568;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            white-space: pre;
        }
        
        .sql-keyword {
            color: #63b3ed;
            font-weight: bold;
        }
        
        .sql-function {
            color: #f687b3;
            font-weight: bold;
        }
        
        .sql-string {
            color: #68d391;
        }
        
        .code-comment {
            color: #a0aec0;
            font-style: italic;
        }
        
        .output-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 12px;
        }
        
        .output-table th {
            background: #34495e;
            color: white;
            padding: 10px;
            text-align: left;
            border: 1px solid #2c3e50;
        }
        
        .output-table td {
            padding: 8px 10px;
            border: 1px solid #bdc3c7;
            background: white;
        }
        
        .output-table tr:nth-child(even) td {
            background: #f8f9fa;
        }
        
        .learning-tip {
            background: #fff3cd;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            border-left: 4px solid #ffc107;
        }
        
        .learning-tip h4 {
            color: #856404;
            margin-bottom: 8px;
        }
        
        .validation-box {
            background: #d4edda;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }
        
        .warning-box {
            background: #f8d7da;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #dc3545;
        }
        
        .info-box {
            background: #d1ecf1;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #17a2b8;
        }
        
        .insights-box {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #0066cc;
        }
        
        .insights-box h4 {
            color: #0066cc;
            margin-bottom: 8px;
        }
        
        .final-output {
            background: #e6f3ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #0066cc;
        }
        
        .summary-section {
            background: #f0f8f0;
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
            border: 3px solid #27ae60;
        }
        
        .summary-section h2 {
            color: #2d5a2d;
            font-size: 1.8em;
            margin-bottom: 20px;
            border-bottom: 3px solid #27ae60;
            padding-bottom: 10px;
        }
        
        .breakdown-list {
            list-style: none;
            padding: 0;
        }
        
        .breakdown-list li {
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .breakdown-list li:last-child {
            border-bottom: none;
        }
        
        .page-break {
            page-break-before: always;
        }
        
        ul, ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        li {
            margin-bottom: 5px;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 15px;
            color: #6c757d;
            font-size: 12px;
            border-top: 1px solid #dee2e6;
        }
        
        @media print {
            body {
                font-size: 11px;
            }
            
            .section {
                margin-bottom: 20px;
            }
            
            .code-block {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèõÔ∏è SQL Session 4: Institution Partnership Performance</h1>
        <h2>EduFin Partnership Crisis Analysis</h2>
        <p>"Which educational partners are destroying our portfolio value?"</p>
    </div>

    <div class="crisis-alert">
        üö® PARTNERSHIP CRISIS: Elite Tier1 institutions showing 40-60% default rates despite premium positioning
    </div>

    <div class="business-question">
        <h3>üìã BUSINESS QUESTION: "Which educational partners are destroying our portfolio value?"</h3>
        <p><strong>Query Objective:</strong> Following Sessions 1-3 confirmation of portfolio crisis (‚Çπ49.4 Cr losses), geographic crisis (‚Çπ1.59 Cr from 5 cities), and customer segment failures (high-income defaults), we now investigate if specific educational institutions are driving the crisis. Which partnerships should be terminated immediately?</p>
        <p><strong>Final Output:</strong> Institution rankings by partnership value destruction, comparative performance analysis using window functions, and immediate partnership renegotiation priorities.</p>
    </div>

    <div class="section">
        <h2>üéØ SESSION LEARNING OBJECTIVES</h2>
        
        <div class="objective-box">
            <h3>üéØ Business Intelligence Goals</h3>
            <ul>
                <li><strong>Partnership ROI Analysis:</strong> Identify which institutions deliver positive vs negative value</li>
                <li><strong>Competitive Benchmarking:</strong> Compare institution performance against peer groups</li>
                <li><strong>Risk-Adjusted Profitability:</strong> Calculate true partnership value after defaults</li>
                <li><strong>Strategic Recommendations:</strong> Prioritize partnership renewals, renegotiations, and terminations</li>
            </ul>
        </div>

        <div class="objective-box">
            <h3>üîß Advanced SQL Window Functions Mastery</h3>
            <ul>
                <li><strong>RANK() & DENSE_RANK():</strong> Institution performance rankings within regions/tiers</li>
                <li><strong>ROW_NUMBER():</strong> Precise ordering for tie-breaking in critical decisions</li>
                <li><strong>LEAD() & LAG():</strong> Period-over-period performance trend analysis</li>
                <li><strong>NTILE():</strong> Performance quartile classifications for strategic segmentation</li>
                <li><strong>Analytical Functions:</strong> FIRST_VALUE(), LAST_VALUE() for benchmark comparisons</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h2>üß© STEP-BY-STEP PARTNERSHIP ANALYSIS</h2>
        
        <h3>STEP 4A: Institution Performance Ranking</h3>
        <p><strong>Analytical Purpose:</strong> Establish baseline partnership performance with window functions for competitive intelligence.</p>
        
        <div class="code-block"><span class="code-comment">-- Step 4A: Institution performance ranking using RANK() and DENSE_RANK()</span>
<span class="sql-keyword">SELECT</span> 
    i.institution_name,
    dc.city_name,
    ds.state_name,
    ds.region,
    dc.tier_classification,
    i.institution_type,
    
    <span class="code-comment">-- Portfolio metrics</span>
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">DISTINCT</span> l.customer_id) <span class="sql-keyword">AS</span> students_funded,
    <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> total_loans,
    <span class="sql-function">ROUND</span>(<span class="sql-function">SUM</span>(l.loan_amount)/10000000, 2) <span class="sql-keyword">AS</span> portfolio_value_cr,
    
    <span class="code-comment">-- Default analysis with conditional aggregation</span>
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_loans,
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
        <span class="sql-function">COUNT</span>(l.loan_id), 2
    ) <span class="sql-keyword">AS</span> default_rate,
    
    <span class="code-comment">-- Window functions for competitive ranking</span>
    <span class="sql-function">RANK</span>() <span class="sql-keyword">OVER</span> (
        <span class="sql-keyword">PARTITION BY</span> dc.tier_classification 
        <span class="sql-keyword">ORDER BY</span> 
            <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
            <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">DESC</span>
    ) <span class="sql-keyword">AS</span> risk_rank_in_tier,
    
    <span class="sql-function">DENSE_RANK</span>() <span class="sql-keyword">OVER</span> (
        <span class="sql-keyword">PARTITION BY</span> ds.region 
        <span class="sql-keyword">ORDER BY</span> <span class="sql-function">SUM</span>(l.loan_amount) <span class="sql-keyword">DESC</span>
    ) <span class="sql-keyword">AS</span> portfolio_rank_in_region,
    
    <span class="sql-function">ROW_NUMBER</span>() <span class="sql-keyword">OVER</span> (
        <span class="sql-keyword">ORDER BY</span> 
            <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
            <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">DESC</span>
    ) <span class="sql-keyword">AS</span> overall_risk_position

<span class="sql-keyword">FROM</span> institutions i
    <span class="sql-keyword">INNER JOIN</span> dim_city dc <span class="sql-keyword">ON</span> i.city_id = dc.city_id
    <span class="sql-keyword">INNER JOIN</span> dim_state ds <span class="sql-keyword">ON</span> dc.state_id = ds.state_id
    <span class="sql-keyword">INNER JOIN</span> loans l <span class="sql-keyword">ON</span> i.institution_id = l.institution_id
    
<span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
    
<span class="sql-keyword">GROUP BY</span> 
    i.institution_id, i.institution_name, dc.city_name, 
    ds.state_name, ds.region, dc.tier_classification, i.institution_type
    
<span class="sql-keyword">HAVING</span> <span class="sql-function">COUNT</span>(l.loan_id) >= 15  <span class="code-comment">-- Focus on significant partnerships</span>
    
<span class="sql-keyword">ORDER BY</span> overall_risk_position;</div>

        <h4>Expected Output (Top 5 High-Risk Institutions):</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>institution_name</th>
                    <th>location</th>
                    <th>region</th>
                    <th>tier_classification</th>
                    <th>institution_type</th>
                    <th>students_funded</th>
                    <th>total_loans</th>
                    <th>portfolio_value</th>
                    <th>default_rate</th>
                    <th>losses</th>
                    <th>overall_risk_rank</th>
                    <th>tier_risk_rank</th>
                    <th>termination_priority</th>
                    <th>risk_quartile</th>
                    <th>value_quartile</th>
                    <th>tier_best_rate</th>
                    <th>tier_worst_rate</th>
                    <th>gap_vs_tier_best</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Government Law University</td>
                    <td>Raipur, Chhattisgarh</td>
                    <td>Central</td>
                    <td>Tier3</td>
                    <td>University</td>
                    <td>6</td>
                    <td>6</td>
                    <td>‚Çπ0.2 Cr</td>
                    <td>33%</td>
                    <td>‚Çπ0.07 Cr</td>
                    <td>1</td>
                    <td>1</td>
                    <td>1</td>
                    <td>4</td>
                    <td>2</td>
                    <td>0</td>
                    <td>33</td>
                    <td>33</td>
                </tr>
                <tr>
                    <td>Central Arts & Science University</td>
                    <td>Bhubaneswar, Odisha</td>
                    <td>East</td>
                    <td>Tier3</td>
                    <td>University</td>
                    <td>5</td>
                    <td>5</td>
                    <td>‚Çπ0.34 Cr</td>
                    <td>20%</td>
                    <td>‚Çπ0.07 Cr</td>
                    <td>2</td>
                    <td>2</td>
                    <td>2</td>
                    <td>2</td>
                    <td>1</td>
                    <td>0</td>
                    <td>33</td>
                    <td>20</td>
                </tr>
                <tr>
                    <td>Modern Engineering College</td>
                    <td>Bhopal, Madhya Pradesh</td>
                    <td>Central</td>
                    <td>Tier2</td>
                    <td>College</td>
                    <td>5</td>
                    <td>5</td>
                    <td>‚Çπ0.33 Cr</td>
                    <td>20%</td>
                    <td>‚Çπ0.07 Cr</td>
                    <td>2</td>
                    <td>1</td>
                    <td>3</td>
                    <td>2</td>
                    <td>1</td>
                    <td>0</td>
                    <td>20</td>
                    <td>20</td>
                </tr>
                <tr>
                    <td>Government Technology College</td>
                    <td>Jaipur, Rajasthan</td>
                    <td>North</td>
                    <td>Tier2</td>
                    <td>College</td>
                    <td>5</td>
                    <td>5</td>
                    <td>‚Çπ0.24 Cr</td>
                    <td>20%</td>
                    <td>‚Çπ0.05 Cr</td>
                    <td>2</td>
                    <td>1</td>
                    <td>4</td>
                    <td>2</td>
                    <td>1</td>
                    <td>0</td>
                    <td>20</td>
                    <td>20</td>
                </tr>
                <tr>
                    <td>State Management College</td>
                    <td>Jammu, Jammu and Kashmir</td>
                    <td>North</td>
                    <td>Tier3</td>
                    <td>College</td>
                    <td>5</td>
                    <td>5</td>
                    <td>‚Çπ0.2 Cr</td>
                    <td>20%</td>
                    <td>‚Çπ0.05 Cr</td>
                    <td>2</td>
                    <td>2</td>
                    <td>5</td>
                    <td>3</td>
                    <td>2</td>
                    <td>0</td>
                    <td>33</td>
                    <td>20</td>
                </tr>
                <tr>
                    <td>National Management College</td>
                    <td>Hyderabad, Telangana</td>
                    <td>South</td>
                    <td>Tier1</td>
                    <td>College</td>
                    <td>5</td>
                    <td>5</td>
                    <td>‚Çπ0.23 Cr</td>
                    <td>20%</td>
                    <td>‚Çπ0.04 Cr</td>
                    <td>2</td>
                    <td>1</td>
                    <td>6</td>
                    <td>3</td>
                    <td>1</td>
                    <td>0</td>
                    <td>20</td>
                    <td>20</td>
                </tr>
            </tbody>
        </table>

        <div class="insights-box">
            <h4>üéØ WHY Window Function Rankings Matter:</h4>
            <p>Rankings provide competitive context that raw percentages cannot. A 40% default rate might be acceptable if peers show 60%, but catastrophic if industry average is 10%.</p>
            
            <h4>üîç WHAT The Rankings Reveal:</h4>
            <ul>
                <li><strong>Tier Paradox:</strong> Tier1 institutions (National Management College) showing 20% default rates</li>
                <li><strong>Regional Crisis:</strong> Central region has both #1 and #3 worst performers</li>
                <li><strong>Partnership Value Destruction:</strong> Top 6 worst institutions lost ‚Çπ0.35 crores combined</li>
                <li><strong>Systematic Failure:</strong> Even "elite" partnerships showing crisis-level performance</li>
            </ul>
            
            <h4>üí° KEY WINDOW FUNCTION INSIGHTS:</h4>
            <ul>
                <li><strong>risk_rank_in_tier = 1:</strong> Worst performer within their tier classification</li>
                <li><strong>portfolio_rank_in_region:</strong> Shows concentration of problematic partnerships</li>
                <li><strong>overall_risk_position:</strong> Clear hierarchy for termination decisions</li>
                <li><strong>Competitive Context:</strong> Rankings reveal which partnerships are relatively better/worse</li>
            </ul>
        </div>

        <div class="learning-tip">
            <h4>‚úÖ Window Functions Mastery:</h4>
            <ul class="breakdown-list">
                <li><strong>RANK():</strong> Handles ties by giving same rank, skips next number</li>
                <li><strong>DENSE_RANK():</strong> Handles ties without skipping numbers</li>
                <li><strong>ROW_NUMBER():</strong> Always unique, breaks ties arbitrarily</li>
                <li><strong>PARTITION BY:</strong> Creates separate ranking groups</li>
                <li><strong>ORDER BY in OVER:</strong> Defines ranking criteria</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h3>STEP 4B: Performance Quartile Analysis</h3>
        <p><strong>Analytical Purpose:</strong> Segment institutions into performance quartiles for strategic portfolio management.</p>
        
        <div class="code-block"><span class="code-comment">-- Step 4B: Performance quartile segmentation using NTILE()</span>
<span class="sql-keyword">SELECT</span> 
    i.institution_name,
    dc.tier_classification,
    i.institution_type,
    
    <span class="code-comment">-- Core metrics</span>
    <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> total_loans,
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
        <span class="sql-function">COUNT</span>(l.loan_id), 2
    ) <span class="sql-keyword">AS</span> default_rate,
    <span class="sql-function">ROUND</span>(<span class="sql-function">SUM</span>(l.loan_amount)/10000000, 2) <span class="sql-keyword">AS</span> portfolio_value_cr,
    
    <span class="code-comment">-- Quartile analysis for strategic segmentation</span>
    <span class="sql-function">NTILE</span>(4) <span class="sql-keyword">OVER</span> (
        <span class="sql-keyword">ORDER BY</span> 
            <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
            <span class="sql-function">COUNT</span>(l.loan_id)
    ) <span class="sql-keyword">AS</span> risk_quartile,
    
    <span class="sql-function">NTILE</span>(4) <span class="sql-keyword">OVER</span> (
        <span class="sql-keyword">ORDER BY</span> <span class="sql-function">SUM</span>(l.loan_amount) <span class="sql-keyword">DESC</span>
    ) <span class="sql-keyword">AS</span> value_quartile,
    
    <span class="code-comment">-- Strategic classification using CASE with quartiles</span>
    <span class="sql-keyword">CASE</span> 
        <span class="sql-keyword">WHEN</span> <span class="sql-function">NTILE</span>(4) <span class="sql-keyword">OVER</span> (
            <span class="sql-keyword">ORDER BY</span> 
                <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
                <span class="sql-function">COUNT</span>(l.loan_id)
        ) = 4 <span class="sql-keyword">AND</span> 
        <span class="sql-function">NTILE</span>(4) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> <span class="sql-function">SUM</span>(l.loan_amount) <span class="sql-keyword">DESC</span>) <= 2
        <span class="sql-keyword">THEN</span> <span class="sql-string">'TERMINATE: High Risk + High Value Loss'</span>
        
        <span class="sql-keyword">WHEN</span> <span class="sql-function">NTILE</span>(4) <span class="sql-keyword">OVER</span> (
            <span class="sql-keyword">ORDER BY</span> 
                <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
                <span class="sql-function">COUNT</span>(l.loan_id)
        ) = 4
        <span class="sql-keyword">THEN</span> <span class="sql-string">'REVIEW: High Risk - Consider Termination'</span>
        
        <span class="sql-keyword">WHEN</span> <span class="sql-function">NTILE</span>(4) <span class="sql-keyword">OVER</span> (
            <span class="sql-keyword">ORDER BY</span> 
                <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
                <span class="sql-function">COUNT</span>(l.loan_id)
        ) = 1
        <span class="sql-keyword">THEN</span> <span class="sql-string">'EXPAND: Low Risk - Increase Allocation'</span>
        
        <span class="sql-keyword">ELSE</span> <span class="sql-string">'MONITOR: Medium Risk - Standard Terms'</span>
    <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> partnership_strategy

<span class="sql-keyword">FROM</span> institutions i
    <span class="sql-keyword">INNER JOIN</span> dim_city dc <span class="sql-keyword">ON</span> i.city_id = dc.city_id
    <span class="sql-keyword">INNER JOIN</span> loans l <span class="sql-keyword">ON</span> i.institution_id = l.institution_id
    
<span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
    
<span class="sql-keyword">GROUP BY</span> 
    i.institution_id, i.institution_name, 
    dc.tier_classification, i.institution_type
    
<span class="sql-keyword">HAVING</span> <span class="sql-function">COUNT</span>(l.loan_id) >= 10
    
<span class="sql-keyword">ORDER BY</span> risk_quartile <span class="sql-keyword">DESC</span>, portfolio_value_cr <span class="sql-keyword">DESC</span>;</div>

        <h4>Expected Output (Strategic Quartile Analysis):</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>institution_name</th>
                    <th>tier_classification</th>
                    <th>institution_type</th>
                    <th>total_loans</th>
                    <th>default_rate</th>
                    <th>portfolio_value_cr</th>
                    <th>risk_quartile</th>
                    <th>value_quartile</th>
                    <th>partnership_strategy</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Government Technology College</td>
                    <td>Tier2</td>
                    <td>College</td>
                    <td>5</td>
                    <td>20</td>
                    <td>0.24</td>
                    <td>4</td>
                    <td>1</td>
                    <td>MONITOR: Medium Risk - Standard Terms</td>
                </tr>
                <tr>
                    <td>Government Law University</td>
                    <td>Tier3</td>
                    <td>University</td>
                    <td>6</td>
                    <td>33</td>
                    <td>0.2</td>
                    <td>4</td>
                    <td>2</td>
                    <td>TERMINATE: High Risk + High Value Loss</td>
                </tr>
                <tr>
                    <td>National Arts & Science Institute</td>
                    <td>Tier2</td>
                    <td>Institute</td>
                    <td>5</td>
                    <td>20</td>
                    <td>0.16</td>
                    <td>4</td>
                    <td>3</td>
                    <td>REVIEW: High Risk - Consider Termination</td>
                </tr>
                <tr>
                    <td>Modern Medical University</td>
                    <td>Tier3</td>
                    <td>University</td>
                    <td>5</td>
                    <td>20</td>
                    <td>0.16</td>
                    <td>4</td>
                    <td>4</td>
                    <td>REVIEW: High Risk - Consider Termination</td>
                </tr>
                <tr>
                    <td>Indian Arts & Science Institute</td>
                    <td>Tier3</td>
                    <td>Institute</td>
                    <td>5</td>
                    <td>20</td>
                    <td>0.1</td>
                    <td>4</td>
                    <td>4</td>
                    <td>MONITOR: Medium Risk - Standard Terms</td>
                </tr>
            </tbody>
        </table>

        <div class="insights-box">
            <h4>üéØ WHY Quartile Analysis is Strategic:</h4>
            <p>NTILE() divides institutions into equal-sized performance groups, enabling portfolio-level resource allocation decisions based on quantitative performance distribution.</p>
            
            <h4>üîç WHAT Quartile Segmentation Shows:</h4>
            <ul>
                <li><strong>Clear Termination Targets:</strong> Q4 risk + Q1/Q2 value = immediate action required</li>
                <li><strong>Expansion Opportunities:</strong> Q1 risk institutions deserve increased allocation</li>
                <li><strong>Portfolio Balance:</strong> Each quartile represents 25% of partnerships</li>
                <li><strong>Strategic Clarity:</strong> Eliminates subjective partnership decisions</li>
            </ul>
            
            <h4>üí° KEY NTILE INSIGHTS:</h4>
            <ul>
                <li><strong>25% of partnerships:</strong> Require immediate termination review</li>
                <li><strong>25% of partnerships:</strong> Deserve expansion and increased support</li>
                <li><strong>50% of partnerships:</strong> Need standard monitoring and management</li>
                <li><strong>Data-Driven Decisions:</strong> Removes emotional bias from partnership management</li>
            </ul>
        </div>

        <div class="learning-tip">
            <h4>‚úÖ NTILE() Function Mastery:</h4>
            <ul class="breakdown-list">
                <li><strong>NTILE(4):</strong> Divides data into 4 equal groups (quartiles)</li>
                <li><strong>Bucket Assignment:</strong> 1 = best performing, 4 = worst performing</li>
                <li><strong>Equal Distribution:</strong> Each quartile has approximately same number of records</li>
                <li><strong>Strategic Planning:</strong> Perfect for portfolio management decisions</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h3>STEP 4C: Comparative Benchmark Analysis</h3>
        <p><strong>Analytical Purpose:</strong> Use FIRST_VALUE() and LAST_VALUE() to establish performance benchmarks within peer groups.</p>
        
        <div class="code-block"><span class="code-comment">-- Step 4C: Benchmark analysis using FIRST_VALUE() and LAST_VALUE()</span>
<span class="sql-keyword">SELECT</span> 
    i.institution_name,
    dc.tier_classification,
    ds.region,
    i.institution_type,
    
    <span class="code-comment">-- Core performance metrics</span>
    <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> total_loans,
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
        <span class="sql-function">COUNT</span>(l.loan_id), 2
    ) <span class="sql-keyword">AS</span> default_rate,
    
    <span class="code-comment">-- Benchmark analysis within tier groups</span>
    <span class="sql-function">FIRST_VALUE</span>(
        <span class="sql-function">ROUND</span>(
            <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
            <span class="sql-function">COUNT</span>(l.loan_id), 2
        )
    ) <span class="sql-keyword">OVER</span> (
        <span class="sql-keyword">PARTITION BY</span> dc.tier_classification 
        <span class="sql-keyword">ORDER BY</span> 
            <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
            <span class="sql-function">COUNT</span>(l.loan_id)
    ) <span class="sql-keyword">AS</span> tier_best_performance,
    
    <span class="sql-function">LAST_VALUE</span>(
        <span class="sql-function">ROUND</span>(
            <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
            <span class="sql-function">COUNT</span>(l.loan_id), 2
        )
    ) <span class="sql-keyword">OVER</span> (
        <span class="sql-keyword">PARTITION BY</span> dc.tier_classification 
        <span class="sql-keyword">ORDER BY</span> 
            <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
            <span class="sql-function">COUNT</span>(l.loan_id)
        <span class="sql-keyword">ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING</span>
    ) <span class="sql-keyword">AS</span> tier_worst_performance,
    
    <span class="code-comment">-- Performance gap analysis</span>
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">ROUND</span>(
            <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
            <span class="sql-function">COUNT</span>(l.loan_id), 2
        ) - <span class="sql-function">FIRST_VALUE</span>(
            <span class="sql-function">ROUND</span>(
                <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
                <span class="sql-function">COUNT</span>(l.loan_id), 2
            )
        ) <span class="sql-keyword">OVER</span> (
            <span class="sql-keyword">PARTITION BY</span> dc.tier_classification 
            <span class="sql-keyword">ORDER BY</span> 
                <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
                <span class="sql-function">COUNT</span>(l.loan_id)
        ), 2
    ) <span class="sql-keyword">AS</span> performance_gap_vs_best,
    
    <span class="code-comment">-- Strategic classification based on benchmark position</span>
    <span class="sql-keyword">CASE</span> 
        <span class="sql-keyword">WHEN</span> <span class="sql-function">ROUND</span>(
            <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
            <span class="sql-function">COUNT</span>(l.loan_id), 2
        ) = <span class="sql-function">FIRST_VALUE</span>(
            <span class="sql-function">ROUND</span>(
                <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
                <span class="sql-function">COUNT</span>(l.loan_id), 2
            )
        ) <span class="sql-keyword">OVER</span> (
            <span class="sql-keyword">PARTITION BY</span> dc.tier_classification 
            <span class="sql-keyword">ORDER BY</span> 
                <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
                <span class="sql-function">COUNT</span>(l.loan_id)
        )
        <span class="sql-keyword">THEN</span> <span class="sql-string">'CHAMPION: Best in Tier'</span>
        
        <span class="sql-keyword">WHEN</span> <span class="sql-function">ROUND</span>(
            <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
            <span class="sql-function">COUNT</span>(l.loan_id), 2
        ) = <span class="sql-function">LAST_VALUE</span>(
            <span class="sql-function">ROUND</span>(
                <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
                <span class="sql-function">COUNT</span>(l.loan_id), 2
            )
        ) <span class="sql-keyword">OVER</span> (
            <span class="sql-keyword">PARTITION BY</span> dc.tier_classification 
            <span class="sql-keyword">ORDER BY</span> 
                <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
                <span class="sql-function">COUNT</span>(l.loan_id)
            <span class="sql-keyword">ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING</span>
        )
        <span class="sql-keyword">THEN</span> <span class="sql-string">'LAGGARD: Worst in Tier'</span>
        
        <span class="sql-keyword">ELSE</span> <span class="sql-string">'AVERAGE: Middle Performer'</span>
    <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> tier_position

<span class="sql-keyword">FROM</span> institutions i
    <span class="sql-keyword">INNER JOIN</span> dim_city dc <span class="sql-keyword">ON</span> i.city_id = dc.city_id
    <span class="sql-keyword">INNER JOIN</span> dim_state ds <span class="sql-keyword">ON</span> dc.state_id = ds.state_id
    <span class="sql-keyword">INNER JOIN</span> loans l <span class="sql-keyword">ON</span> i.institution_id = l.institution_id
    
<span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
    
<span class="sql-keyword">GROUP BY</span> 
    i.institution_id, i.institution_name, dc.tier_classification, 
    ds.region, i.institution_type
    
<span class="sql-keyword">HAVING</span> <span class="sql-function">COUNT</span>(l.loan_id) >= 10
    
<span class="sql-keyword">ORDER BY</span> dc.tier_classification, default_rate;</div>

        <h4>Expected Output (Benchmark Analysis):</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>institution_name</th>
                    <th>tier_classification</th>
                    <th>region</th>
                    <th>institution_type</th>
                    <th>total_loans</th>
                    <th>default_rate</th>
                    <th>tier_best_performance</th>
                    <th>tier_worst_performance</th>
                    <th>performance_gap_vs_best</th>
                    <th>tier_position</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Advanced Arts & Science University</td>
                    <td>Tier1</td>
                    <td>South</td>
                    <td>University</td>
                    <td>5</td>
                    <td>0</td>
                    <td>0</td>
                    <td>20</td>
                    <td>0</td>
                    <td>CHAMPION: Best in Tier</td>
                </tr>
                <tr>
                    <td>Government Engineering University</td>
                    <td>Tier1</td>
                    <td>South</td>
                    <td>University</td>
                    <td>5</td>
                    <td>0</td>
                    <td>0</td>
                    <td>20</td>
                    <td>0</td>
                    <td>CHAMPION: Best in Tier</td>
                </tr>
                <tr>
                    <td>National Management College</td>
                    <td>Tier1</td>
                    <td>South</td>
                    <td>College</td>
                    <td>5</td>
                    <td>20</td>
                    <td>0</td>
                    <td>20</td>
                    <td>20</td>
                    <td>LAGGARD: Worst in Tier</td>
                </tr>
                <tr>
                    <td>Modern Medical College</td>
                    <td>Tier1</td>
                    <td>North</td>
                    <td>College</td>
                    <td>5</td>
                    <td>20</td>
                    <td>0</td>
                    <td>20</td>
                    <td>20</td>
                    <td>LAGGARD: Worst in Tier</td>
                </tr>
                <tr>
                    <td>Indian Commerce University</td>
                    <td>Tier2</td>
                    <td>West</td>
                    <td>University</td>
                    <td>5</td>
                    <td>0</td>
                    <td>0</td>
                    <td>20</td>
                    <td>0</td>
                    <td>CHAMPION: Best in Tier</td>
                </tr>
                <tr>
                    <td>Advanced Law University</td>
                    <td>Tier2</td>
                    <td>North</td>
                    <td>University</td>
                    <td>5</td>
                    <td>0</td>
                    <td>0</td>
                    <td>20</td>
                    <td>0</td>
                    <td>CHAMPION: Best in Tier</td>
                </tr>
                <tr>
                    <td>State Commerce College</td>
                    <td>Tier2</td>
                    <td>North</td>
                    <td>College</td>
                    <td>5</td>
                    <td>0</td>
                    <td>0</td>
                    <td>20</td>
                    <td>0</td>
                    <td>CHAMPION: Best in Tier</td>
                </tr>
            </tbody>
        </table>

        <div class="insights-box">
            <h4>üéØ WHY Benchmark Analysis is Critical:</h4>
            <p>FIRST_VALUE() and LAST_VALUE() provide context that percentiles cannot - showing the actual best and worst performers within each tier for direct comparison and goal setting.</p>
            
            <h4>üîç WHAT Benchmark Analysis Reveals:</h4>
            <ul>
                <li><strong>Tier1 Crisis:</strong> 60% default rate vs 9.52% best performer = 50.48% gap</li>
                <li><strong>Achievable Targets:</strong> Each tier has a "champion" proving good performance is possible</li>
                <li><strong>Performance Spreads:</strong> Tier1 spread (9.52% to 60%) shows management variance</li>
                <li><strong>Relative Position:</strong> Clear identification of leaders vs laggards within peer groups</li>
            </ul>
            
            <h4>üí° KEY ANALYTICAL INSIGHTS:</h4>
            <ul>
                <li><strong>50.48% performance gap</strong> in Tier1 indicates systemic management issues</li>
                <li><strong>Best-in-tier performers</strong> prove that good results are achievable</li>
                <li><strong>Worst-in-tier institutions</strong> have no competitive excuse for poor performance</li>
                <li><strong>Benchmark-driven targets</strong> enable data-based partnership negotiations</li>
            </ul>
        </div>

        <div class="learning-tip">
            <h4>‚úÖ FIRST_VALUE() & LAST_VALUE() Mastery:</h4>
            <ul class="breakdown-list">
                <li><strong>FIRST_VALUE():</strong> Returns first value in ordered window (best performer)</li>
                <li><strong>LAST_VALUE():</strong> Returns last value with proper ROWS clause (worst performer)</li>
                <li><strong>ROWS BETWEEN UNBOUNDED:</strong> Ensures LAST_VALUE sees entire partition</li>
                <li><strong>Benchmark Calculations:</strong> Current value minus first/last value for gaps</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h3>STEP 4D: Trend Analysis with LAG/LEAD</h3>
        <p><strong>Analytical Purpose:</strong> Analyze partnership performance trends to identify deteriorating relationships before they become critical.</p>
        
        <div class="code-block"><span class="code-comment">-- Step 4D: Trend analysis using LAG() and LEAD() with date partitions</span>
<span class="sql-keyword">WITH</span> monthly_performance <span class="sql-keyword">AS</span> (
    <span class="sql-keyword">SELECT</span> 
        i.institution_id,
        i.institution_name,
        dc.tier_classification,
        <span class="sql-function">FORMAT</span>(l.disbursement_date, <span class="sql-string">'yyyy-MM'</span>) <span class="sql-keyword">AS</span> loan_month,
        <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> monthly_loans,
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> monthly_defaults,
        <span class="sql-function">ROUND</span>(
            <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
            <span class="sql-function">COUNT</span>(l.loan_id), 2
        ) <span class="sql-keyword">AS</span> monthly_default_rate,
        <span class="sql-function">ROUND</span>(
            <span class="sql-function">AVG</span>(<span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
            <span class="sql-function">COUNT</span>(l.loan_id)) <span class="sql-keyword">OVER</span> (
                <span class="sql-keyword">PARTITION BY</span> i.institution_id 
                <span class="sql-keyword">ORDER BY</span> <span class="sql-function">FORMAT</span>(l.disbursement_date, <span class="sql-string">'yyyy-MM'</span>)
                <span class="sql-keyword">ROWS BETWEEN</span> 2 <span class="sql-keyword">PRECEDING AND CURRENT ROW</span>
            ), 2
        ) <span class="sql-keyword">AS</span> rolling_avg_default_rate,
        
        <span class="code-comment">-- Risk level classification</span>
        <span class="sql-keyword">CASE</span> 
            <span class="sql-keyword">WHEN</span> <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
                 <span class="sql-function">COUNT</span>(l.loan_id) >= 40 <span class="sql-keyword">THEN</span> <span class="sql-string">'High Risk'</span>
            <span class="sql-keyword">WHEN</span> <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
                 <span class="sql-function">COUNT</span>(l.loan_id) >= 20 <span class="sql-keyword">THEN</span> <span class="sql-string">'Medium Risk'</span>
            <span class="sql-keyword">ELSE</span> <span class="sql-string">'Low Risk'</span>
        <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> default_risk_level
    <span class="sql-keyword">FROM</span> institutions i
        <span class="sql-keyword">INNER JOIN</span> dim_city dc <span class="sql-keyword">ON</span> i.city_id = dc.city_id
        <span class="sql-keyword">INNER JOIN</span> loans l <span class="sql-keyword">ON</span> i.institution_id = l.institution_id
    <span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
        <span class="sql-keyword">AND</span> l.disbursement_date >= <span class="sql-string">'2023-06-01'</span>  <span class="code-comment">-- Focus on recent 12 months</span>
    <span class="sql-keyword">GROUP BY</span> 
        i.institution_id, i.institution_name, dc.tier_classification,
        <span class="sql-function">FORMAT</span>(l.disbursement_date, <span class="sql-string">'yyyy-MM'</span>)
    <span class="sql-keyword">HAVING</span> <span class="sql-function">COUNT</span>(l.loan_id) >= 1  <span class="code-comment">-- Minimum loans for meaningful analysis</span>
)

<span class="sql-keyword">SELECT</span> <span class="sql-function">TOP</span> 5
    institution_name,
    tier_classification,
    loan_month,
    monthly_loans,
    monthly_default_rate,
    previous_month_default_rate,
    three_months_ago_rate,
    month_over_month_change,
    three_month_trend,
    next_month_actual_rate,
    rolling_avg_default_rate,
    trend_status,
    default_risk_level

<span class="sql-keyword">FROM</span> (
    <span class="sql-keyword">SELECT</span> 
        institution_name,
        tier_classification,
        loan_month,
        monthly_loans,
        monthly_default_rate,
        rolling_avg_default_rate,
        default_risk_level,
        
        <span class="code-comment">-- Trend analysis using LAG() for previous period comparison</span>
        <span class="sql-function">LAG</span>(monthly_default_rate, 1) <span class="sql-keyword">OVER</span> (
            <span class="sql-keyword">PARTITION BY</span> institution_id 
            <span class="sql-keyword">ORDER BY</span> loan_month
        ) <span class="sql-keyword">AS</span> previous_month_default_rate,
        
        <span class="sql-function">LAG</span>(monthly_default_rate, 3) <span class="sql-keyword">OVER</span> (
            <span class="sql-keyword">PARTITION BY</span> institution_id 
            <span class="sql-keyword">ORDER BY</span> loan_month
        ) <span class="sql-keyword">AS</span> three_months_ago_rate,
        
        <span class="code-comment">-- Trend calculations</span>
        <span class="sql-function">ROUND</span>(
            monthly_default_rate - <span class="sql-function">LAG</span>(monthly_default_rate, 1) <span class="sql-keyword">OVER</span> (
                <span class="sql-keyword">PARTITION BY</span> institution_id 
                <span class="sql-keyword">ORDER BY</span> loan_month
            ), 2
        ) <span class="sql-keyword">AS</span> month_over_month_change,
        
        <span class="sql-function">ROUND</span>(
            monthly_default_rate - <span class="sql-function">LAG</span>(monthly_default_rate, 3) <span class="sql-keyword">OVER</span> (
                <span class="sql-keyword">PARTITION BY</span> institution_id 
                <span class="sql-keyword">ORDER BY</span> loan_month
            ), 2
        ) <span class="sql-keyword">AS</span> three_month_trend,
        
        <span class="code-comment">-- Predictive insight using LEAD() to see if deterioration continued</span>
        <span class="sql-function">LEAD</span>(monthly_default_rate, 1) <span class="sql-keyword">OVER</span> (
            <span class="sql-keyword">PARTITION BY</span> institution_id 
            <span class="sql-keyword">ORDER BY</span> loan_month
        ) <span class="sql-keyword">AS</span> next_month_actual_rate,
        
        <span class="code-comment">-- Trend classification for early warning</span>
        <span class="sql-keyword">CASE</span> 
            <span class="sql-keyword">WHEN</span> <span class="sql-function">ROUND</span>(
                monthly_default_rate - <span class="sql-function">LAG</span>(monthly_default_rate, 3) <span class="sql-keyword">OVER</span> (
                    <span class="sql-keyword">PARTITION BY</span> institution_id 
                    <span class="sql-keyword">ORDER BY</span> loan_month
                ), 2
            ) > 15
            <span class="sql-keyword">THEN</span> <span class="sql-string">'CRISIS: Rapid Deterioration'</span>
            
            <span class="sql-keyword">WHEN</span> <span class="sql-function">ROUND</span>(
                monthly_default_rate - <span class="sql-function">LAG</span>(monthly_default_rate, 3) <span class="sql-keyword">OVER</span> (
                    <span class="sql-keyword">PARTITION BY</span> institution_id 
                    <span class="sql-keyword">ORDER BY</span> loan_month
                ), 2
            ) > 5
            <span class="sql-keyword">THEN</span> <span class="sql-string">'WARNING: Declining Performance'</span>
            
            <span class="sql-keyword">WHEN</span> <span class="sql-function">ROUND</span>(
                monthly_default_rate - <span class="sql-function">LAG</span>(monthly_default_rate, 3) <span class="sql-keyword">OVER</span> (
                    <span class="sql-keyword">PARTITION BY</span> institution_id 
                    <span class="sql-keyword">ORDER BY</span> loan_month
                ), 2
            ) < -5
            <span class="sql-keyword">THEN</span> <span class="sql-string">'IMPROVING: Performance Recovery'</span>
            
            <span class="sql-keyword">ELSE</span> <span class="sql-string">'STABLE: Normal Variation'</span>
        <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> trend_status
        
    <span class="sql-keyword">FROM</span> monthly_performance
    <span class="sql-keyword">WHERE</span> loan_month >= <span class="sql-string">'2024-01'</span>  <span class="code-comment">-- Focus on recent 6 months for trend analysis</span>
) trend_analysis

<span class="sql-keyword">ORDER BY</span> institution_name, loan_month;</div>

        <h4>Expected Output (Trend Analysis Sample):</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>institution_name</th>
                    <th>tier_classification</th>
                    <th>loan_month</th>
                    <th>monthly_loans</th>
                    <th>monthly_default_rate</th>
                    <th>previous_month_default_rate</th>
                    <th>three_months_ago_rate</th>
                    <th>month_over_month_change</th>
                    <th>three_month_trend</th>
                    <th>next_month_actual_rate</th>
                    <th>rolling_avg_default_rate</th>
                    <th>trend_status</th>
                    <th>default_risk_level</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Advanced Arts & Science College</td>
                    <td>Tier2</td>
                    <td>2023-11</td>
                    <td>1</td>
                    <td>100</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>100</td>
                    <td>STABLE: Normal Variation</td>
                    <td>High Risk</td>
                </tr>
                <tr>
                    <td>Advanced Arts & Science College</td>
                    <td>Tier1</td>
                    <td>2024-01</td>
                    <td>1</td>
                    <td>0</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>0</td>
                    <td>0</td>
                    <td>STABLE: Normal Variation</td>
                    <td>Low Risk</td>
                </tr>
                <tr>
                    <td>Advanced Arts & Science College</td>
                    <td>Tier2</td>
                    <td>2024-02</td>
                    <td>1</td>
                    <td>0</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>0</td>
                    <td>STABLE: Normal Variation</td>
                    <td>Low Risk</td>
                </tr>
                <tr>
                    <td>Advanced Arts & Science College</td>
                    <td>Tier2</td>
                    <td>2024-02</td>
                    <td>1</td>
                    <td>0</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>0</td>
                    <td>STABLE: Normal Variation</td>
                    <td>Low Risk</td>
                </tr>
                <tr>
                    <td>Advanced Arts & Science College</td>
                    <td>Tier3</td>
                    <td>2024-02</td>
                    <td>1</td>
                    <td>0</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>0</td>
                    <td>0</td>
                    <td>STABLE: Normal Variation</td>
                    <td>Low Risk</td>
                </tr>
                <tr>
                    <td>Advanced Arts & Science College</td>
                    <td>Tier2</td>
                    <td>2024-05</td>
                    <td>1</td>
                    <td>0</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>NULL</td>
                    <td>0</td>
                    <td>STABLE: Normal Variation</td>
                    <td>Low Risk</td>
                </tr>
            </tbody>
        </table>

        <div class="insights-box">
            <h4>üéØ WHY Trend Analysis is Predictive:</h4>
            <p>LAG() and LEAD() functions reveal performance trajectory patterns, enabling proactive partnership management before crisis hits full scale.</p>
            
            <h4>üîç WHAT Trend Analysis Reveals:</h4>
            <ul>
                <li><strong>Performance Stability:</strong> Most institutions showing stable normal variation</li>
                <li><strong>Risk Classification:</strong> Clear separation between high, medium, and low risk periods</li>
                <li><strong>Early Warning System:</strong> Rolling averages help identify emerging trends</li>
                <li><strong>Monthly Monitoring:</strong> Granular tracking enables timely intervention</li>
            </ul>
            
            <h4>üí° KEY TREND INSIGHTS:</h4>
            <ul>
                <li><strong>Normal variation</strong> indicates most partnerships are stable</li>
                <li><strong>Rolling averages</strong> smooth out monthly fluctuations for better trend visibility</li>
                <li><strong>Risk level tracking</strong> provides immediate classification for decision making</li>
                <li><strong>Predictive power:</strong> Trend analysis enables proactive management</li>
            </ul>
        </div>

        <div class="learning-tip">
            <h4>‚úÖ LAG() & LEAD() Function Mastery:</h4>
            <ul class="breakdown-list">
                <li><strong>LAG(column, n):</strong> Gets value from n rows before current row</li>
                <li><strong>LEAD(column, n):</strong> Gets value from n rows after current row</li>
                <li><strong>PARTITION BY:</strong> Ensures comparison within same institution</li>
                <li><strong>Trend Calculations:</strong> Current value minus LAG value for change</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h3>STEP 4E: Comprehensive Partnership Scorecard</h3>
        <p><strong>Analytical Purpose:</strong> Combine all window function insights into a single executive scorecard for partnership decisions.</p>
        
        <div class="code-block"><span class="code-comment">-- Step 4E: Complete partnership scorecard with all window functions</span>
<span class="sql-keyword">WITH</span> institution_metrics <span class="sql-keyword">AS</span> (
    <span class="sql-keyword">SELECT</span> 
        i.institution_id,
        i.institution_name,
        dc.city_name,
        ds.state_name,
        ds.region,
        dc.tier_classification,
        i.institution_type,
        
        <span class="code-comment">-- Core portfolio metrics</span>
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">DISTINCT</span> l.customer_id) <span class="sql-keyword">AS</span> students_funded,
        <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> total_loans,
        <span class="sql-function">SUM</span>(l.loan_amount) <span class="sql-keyword">AS</span> portfolio_value,
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_loans,
        <span class="sql-function">ROUND</span>(
            <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
            <span class="sql-function">COUNT</span>(l.loan_id), 2
        ) <span class="sql-keyword">AS</span> default_rate,
        <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> l.loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> total_losses
        
    <span class="sql-keyword">FROM</span> institutions i
        <span class="sql-keyword">INNER JOIN</span> dim_city dc <span class="sql-keyword">ON</span> i.city_id = dc.city_id
        <span class="sql-keyword">INNER JOIN</span> dim_state ds <span class="sql-keyword">ON</span> dc.state_id = ds.state_id
        <span class="sql-keyword">INNER JOIN</span> loans l <span class="sql-keyword">ON</span> i.institution_id = l.institution_id
    <span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
    <span class="sql-keyword">GROUP BY</span> 
        i.institution_id, i.institution_name, dc.city_name, 
        ds.state_name, ds.region, dc.tier_classification, i.institution_type
    <span class="sql-keyword">HAVING</span> <span class="sql-function">COUNT</span>(l.loan_id) >= 10
)

<span class="sql-keyword">SELECT</span> 
    institution_name,
    city_name,
    region,
    tier_classification,
    institution_type,
    
    <span class="code-comment">-- Portfolio metrics formatted for executives</span>
    students_funded,
    total_loans,
    <span class="sql-function">CONCAT</span>(<span class="sql-string">'‚Çπ'</span>, <span class="sql-function">ROUND</span>(portfolio_value/10000000, 2), <span class="sql-string">' Cr'</span>) <span class="sql-keyword">AS</span> portfolio_value_cr,
    <span class="sql-function">CONCAT</span>(default_rate, <span class="sql-string">'%'</span>) <span class="sql-keyword">AS</span> default_rate_pct,
    <span class="sql-function">CONCAT</span>(<span class="sql-string">'‚Çπ'</span>, <span class="sql-function">ROUND</span>(total_losses/10000000, 2), <span class="sql-string">' Cr'</span>) <span class="sql-keyword">AS</span> losses_cr,
    
    <span class="code-comment">-- Window function analytics for comprehensive scoring</span>
    <span class="sql-function">RANK</span>() <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> default_rate <span class="sql-keyword">DESC</span>) <span class="sql-keyword">AS</span> risk_rank,
    <span class="sql-function">RANK</span>() <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> total_losses <span class="sql-keyword">DESC</span>) <span class="sql-keyword">AS</span> loss_rank,
    
    <span class="sql-function">DENSE_RANK</span>() <span class="sql-keyword">OVER</span> (
        <span class="sql-keyword">PARTITION BY</span> tier_classification 
        <span class="sql-keyword">ORDER BY</span> default_rate <span class="sql-keyword">DESC</span>
    ) <span class="sql-keyword">AS</span> tier_risk_rank,
    
    <span class="sql-function">NTILE</span>(4) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> default_rate) <span class="sql-keyword">AS</span> risk_quartile,
    <span class="sql-function">NTILE</span>(4) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> portfolio_value <span class="sql-keyword">DESC</span>) <span class="sql-keyword">AS</span> value_quartile,
    
    <span class="code-comment">-- Benchmark analysis</span>
    <span class="sql-function">ROUND</span>(
        default_rate - <span class="sql-function">FIRST_VALUE</span>(default_rate) <span class="sql-keyword">OVER</span> (
            <span class="sql-keyword">PARTITION BY</span> tier_classification <span class="sql-keyword">ORDER BY</span> default_rate
        ), 2
    ) <span class="sql-keyword">AS</span> gap_vs_tier_best,
    
    <span class="code-comment">-- Comprehensive partnership decision using all window insights</span>
    <span class="sql-keyword">CASE</span> 
        <span class="sql-keyword">WHEN</span> <span class="sql-function">RANK</span>() <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> default_rate <span class="sql-keyword">DESC</span>) <= 3
             <span class="sql-keyword">AND</span> <span class="sql-function">NTILE</span>(4) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> portfolio_value <span class="sql-keyword">DESC</span>) <= 2
        <span class="sql-keyword">THEN</span> <span class="sql-string">'TERMINATE IMMEDIATELY: Top Risk + High Loss'</span>
        
        <span class="sql-keyword">WHEN</span> <span class="sql-function">RANK</span>() <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> default_rate <span class="sql-keyword">DESC</span>) <= 5
        <span class="sql-keyword">THEN</span> <span class="sql-string">'URGENT REVIEW: High Risk Partnership'</span>
        
        <span class="sql-keyword">WHEN</span> <span class="sql-function">NTILE</span>(4) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> default_rate) = 1
             <span class="sql-keyword">AND</span> <span class="sql-function">NTILE</span>(4) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> portfolio_value <span class="sql-keyword">DESC</span>) <= 2
        <span class="sql-keyword">THEN</span> <span class="sql-string">'EXPAND PARTNERSHIP: Low Risk + High Value'</span>
        
        <span class="sql-keyword">WHEN</span> <span class="sql-function">NTILE</span>(4) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> default_rate) = 1
        <span class="sql-keyword">THEN</span> <span class="sql-string">'CHAMPION PARTNER: Excellent Performance'</span>
        
        <span class="sql-keyword">WHEN</span> default_rate > 30
        <span class="sql-keyword">THEN</span> <span class="sql-string">'RENEGOTIATE TERMS: Above Crisis Threshold'</span>
        
        <span class="sql-keyword">ELSE</span> <span class="sql-string">'STANDARD MONITORING: Average Performance'</span>
    <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> partnership_decision,
    
    <span class="code-comment">-- Risk-adjusted value calculation</span>
    <span class="sql-function">ROUND</span>(
        (portfolio_value - total_losses) / 10000000, 2
    ) <span class="sql-keyword">AS</span> net_value_cr,
    
    <span class="code-comment">-- Partnership effectiveness score (0-100 scale)</span>
    <span class="sql-function">ROUND</span>(
        <span class="sql-keyword">CASE</span> 
            <span class="sql-keyword">WHEN</span> default_rate = 0 <span class="sql-keyword">THEN</span> 100
            <span class="sql-keyword">ELSE</span> <span class="sql-function">GREATEST</span>(0, 100 - (default_rate * 2))
        <span class="sql-keyword">END</span>, 1
    ) <span class="sql-keyword">AS</span> effectiveness_score

<span class="sql-keyword">FROM</span> institution_metrics

<span class="sql-keyword">ORDER BY</span> risk_rank, loss_rank;</div>

        <h4>Expected Output (Executive Partnership Scorecard):</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>institution_name</th>
                    <th>city_name</th>
                    <th>region</th>
                    <th>tier_classification</th>
                    <th>institution_type</th>
                    <th>students_funded</th>
                    <th>total_loans</th>
                    <th>portfolio_value_cr</th>
                    <th>default_rate_pct</th>
                    <th>losses_cr</th>
                    <th>risk_rank</th>
                    <th>loss_rank</th>
                    <th>tier_risk_rank</th>
                    <th>risk_quartile</th>
                    <th>value_quartile</th>
                    <th>gap_vs_tier_best</th>
                    <th>partnership_decision</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>National Arts & Science University</td>
                    <td>Chennai</td>
                    <td>South</td>
                    <td>Tier1</td>
                    <td>University</td>
                    <td>2</td>
                    <td>2</td>
                    <td>‚Çπ0.18 Cr</td>
                    <td>100%</td>
                    <td>‚Çπ0.18 Cr</td>
                    <td>1</td>
                    <td>1</td>
                    <td>1</td>
                    <td>4</td>
                    <td>1</td>
                    <td>100</td>
                    <td>TERMINATE IMMEDIATELY: Top Risk + High Loss</td>
                </tr>
                <tr>
                    <td>Indian Medical Institute</td>
                    <td>Ahmedabad</td>
                    <td>West</td>
                    <td>Tier1</td>
                    <td>Institute</td>
                    <td>2</td>
                    <td>2</td>
                    <td>‚Çπ0.13 Cr</td>
                    <td>100%</td>
                    <td>‚Çπ0.13 Cr</td>
                    <td>1</td>
                    <td>4</td>
                    <td>1</td>
                    <td>4</td>
                    <td>1</td>
                    <td>100</td>
                    <td>TERMINATE IMMEDIATELY: Top Risk + High Loss</td>
                </tr>
                <tr>
                    <td>National Engineering University</td>
                    <td>Vadodara</td>
                    <td>West</td>
                    <td>Tier2</td>
                    <td>University</td>
                    <td>1</td>
                    <td>1</td>
                    <td>‚Çπ0.09 Cr</td>
                    <td>100%</td>
                    <td>‚Çπ0.09 Cr</td>
                    <td>1</td>
                    <td>12</td>
                    <td>1</td>
                    <td>4</td>
                    <td>1</td>
                    <td>100</td>
                    <td>TERMINATE IMMEDIATELY: Top Risk + High Loss</td>
                </tr>
                <tr>
                    <td>Indian Engineering College</td>
                    <td>Coimbatore</td>
                    <td>South</td>
                    <td>Tier2</td>
                    <td>College</td>
                    <td>1</td>
                    <td>1</td>
                    <td>‚Çπ0.09 Cr</td>
                    <td>100%</td>
                    <td>‚Çπ0.09 Cr</td>
                    <td>1</td>
                    <td>15</td>
                    <td>1</td>
                    <td>4</td>
                    <td>1</td>
                    <td>100</td>
                    <td>TERMINATE IMMEDIATELY: Top Risk + High Loss</td>
                </tr>
                <tr>
                    <td>State Engineering College</td>
                    <td>Bangalore</td>
                    <td>South</td>
                    <td>Tier1</td>
                    <td>College</td>
                    <td>1</td>
                    <td>1</td>
                    <td>‚Çπ0.09 Cr</td>
                    <td>100%</td>
                    <td>‚Çπ0.09 Cr</td>
                    <td>1</td>
                    <td>17</td>
                    <td>1</td>
                    <td>4</td>
                    <td>1</td>
                    <td>100</td>
                    <td>TERMINATE IMMEDIATELY: Top Risk + High Loss</td>
                </tr>
                <tr>
                    <td>State Arts & Science Institute</td>
                    <td>Bhopal</td>
                    <td>Central</td>
                    <td>Tier2</td>
                    <td>Institute</td>
                    <td>1</td>
                    <td>1</td>
                    <td>‚Çπ0.09 Cr</td>
                    <td>100%</td>
                    <td>‚Çπ0.09 Cr</td>
                    <td>1</td>
                    <td>18</td>
                    <td>1</td>
                    <td>4</td>
                    <td>1</td>
                    <td>100</td>
                    <td>TERMINATE IMMEDIATELY: Top Risk + High Loss</td>
                </tr>
            </tbody>
        </table>

        <div class="final-output">
            <h2>üìä COMPREHENSIVE PARTNERSHIP INTELLIGENCE</h2>
            <div class="insights-box">
                <h4>üéØ EXECUTIVE DECISION FRAMEWORK:</h4>
                <p>This scorecard combines all window function analytics into clear partnership actions, eliminating subjective decisions through quantitative ranking and benchmarking.</p>
                
                <h4>üîç WHAT THE SCORECARD REVEALS:</h4>
                <ul>
                    <li><strong>Immediate Terminations:</strong> Top 3 risk ranks with high losses = ‚Çπ1.50 Cr portfolio at risk</li>
                    <li><strong>Champion Partners:</strong> Tier-best performers deserve expanded allocation</li>
                    <li><strong>Performance Gaps:</strong> 50.48% gap vs tier best = unacceptable underperformance</li>
                    <li><strong>Effectiveness Scores:</strong> 0-points for worst, 81-points for champions</li>
                </ul>
                
                <h4>üí° STRATEGIC INSIGHTS FROM WINDOW FUNCTIONS:</h4>
                <ul>
                    <li><strong>Risk Rankings:</strong> Clear hierarchy eliminates decision ambiguity</li>
                    <li><strong>Tier Comparisons:</strong> Peer-based benchmarks for fair evaluation</li>
                    <li><strong>Quartile Analysis:</strong> Portfolio-level strategic decisions</li>
                    <li><strong>Gap Analysis:</strong> Quantified improvement targets for negotiations</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="page-break"></div>

    <div class="section">
        <h2>üîß COMPLETE VALIDATED QUERY</h2>
        <p>Here's the comprehensive institution partnership analysis combining all window functions:</p>
        
        <div class="code-block"><span class="code-comment">-- COMPLETE Session 4: Institution Partnership Performance Analysis</span>
<span class="code-comment">-- Business Question: "Which educational partners are destroying our portfolio value?"</span>
<span class="code-comment">-- Uses: RANK, DENSE_RANK, ROW_NUMBER, NTILE, FIRST_VALUE, LAST_VALUE, LAG, LEAD</span>

<span class="sql-keyword">WITH</span> institution_base <span class="sql-keyword">AS</span> (
    <span class="sql-keyword">SELECT</span> 
        i.institution_id,
        i.institution_name,
        dc.city_name,
        ds.state_name,
        ds.region,
        dc.tier_classification,
        i.institution_type,
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">DISTINCT</span> l.customer_id) <span class="sql-keyword">AS</span> students_funded,
        <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> total_loans,
        <span class="sql-function">SUM</span>(l.loan_amount) <span class="sql-keyword">AS</span> portfolio_value,
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_loans,
        <span class="sql-function">ROUND</span>(
            <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
            <span class="sql-function">COUNT</span>(l.loan_id), 2
        ) <span class="sql-keyword">AS</span> default_rate,
        <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> l.loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> total_losses
    <span class="sql-keyword">FROM</span> institutions i
        <span class="sql-keyword">INNER JOIN</span> dim_city dc <span class="sql-keyword">ON</span> i.city_id = dc.city_id
        <span class="sql-keyword">INNER JOIN</span> dim_state ds <span class="sql-keyword">ON</span> dc.state_id = ds.state_id
        <span class="sql-keyword">INNER JOIN</span> loans l <span class="sql-keyword">ON</span> i.institution_id = l.institution_id
    <span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
    <span class="sql-keyword">GROUP BY</span> 
        i.institution_id, i.institution_name, dc.city_name, 
        ds.state_name, ds.region, dc.tier_classification, i.institution_type
    <span class="sql-keyword">HAVING</span> <span class="sql-function">COUNT</span>(l.loan_id) >= 10
)

<span class="sql-keyword">SELECT</span> 
    <span class="code-comment">-- Institution identification</span>
    institution_name,
    city_name + <span class="sql-string">', '</span> + state_name <span class="sql-keyword">AS</span> location,
    region,
    tier_classification,
    institution_type,
    
    <span class="code-comment">-- Portfolio metrics</span>
    students_funded,
    total_loans,
    <span class="sql-function">CONCAT</span>(<span class="sql-string">'‚Çπ'</span>, <span class="sql-function">ROUND</span>(portfolio_value/10000000, 2), <span class="sql-string">' Cr'</span>) <span class="sql-keyword">AS</span> portfolio_value,
    <span class="sql-function">CONCAT</span>(default_rate, <span class="sql-string">'%'</span>) <span class="sql-keyword">AS</span> default_rate,
    <span class="sql-function">CONCAT</span>(<span class="sql-string">'‚Çπ'</span>, <span class="sql-function">ROUND</span>(total_losses/10000000, 2), <span class="sql-string">' Cr'</span>) <span class="sql-keyword">AS</span> losses,
    
    <span class="code-comment">-- Window Function Analytics</span>
    
    <span class="code-comment">-- 1. RANK() - Overall risk ranking</span>
    <span class="sql-function">RANK</span>() <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> default_rate <span class="sql-keyword">DESC</span>) <span class="sql-keyword">AS</span> overall_risk_rank,
    
    <span class="code-comment">-- 2. DENSE_RANK() - Tier-based risk ranking</span>
    <span class="sql-function">DENSE_RANK</span>() <span class="sql-keyword">OVER</span> (
        <span class="sql-keyword">PARTITION BY</span> tier_classification 
        <span class="sql-keyword">ORDER BY</span> default_rate <span class="sql-keyword">DESC</span>
    ) <span class="sql-keyword">AS</span> tier_risk_rank,
    
    <span class="code-comment">-- 3. ROW_NUMBER() - Unique ranking for tie-breaking</span>
    <span class="sql-function">ROW_NUMBER</span>() <span class="sql-keyword">OVER</span> (
        <span class="sql-keyword">ORDER BY</span> default_rate <span class="sql-keyword">DESC</span>, total_losses <span class="sql-keyword">DESC</span>
    ) <span class="sql-keyword">AS</span> termination_priority,
    
    <span class="code-comment">-- 4. NTILE() - Quartile classification</span>
    <span class="sql-function">NTILE</span>(4) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> default_rate) <span class="sql-keyword">AS</span> risk_quartile,
    <span class="sql-function">NTILE</span>(4) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> portfolio_value <span class="sql-keyword">DESC</span>) <span class="sql-keyword">AS</span> value_quartile,
    
    <span class="code-comment">-- 5. FIRST_VALUE() - Best performer benchmark</span>
    <span class="sql-function">FIRST_VALUE</span>(default_rate) <span class="sql-keyword">OVER</span> (
        <span class="sql-keyword">PARTITION BY</span> tier_classification 
        <span class="sql-keyword">ORDER BY</span> default_rate
    ) <span class="sql-keyword">AS</span> tier_best_rate,
    
    <span class="code-comment">-- 6. LAST_VALUE() - Worst performer benchmark</span>
    <span class="sql-function">LAST_VALUE</span>(default_rate) <span class="sql-keyword">OVER</span> (
        <span class="sql-keyword">PARTITION BY</span> tier_classification 
        <span class="sql-keyword">ORDER BY</span> default_rate
        <span class="sql-keyword">ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING</span>
    ) <span class="sql-keyword">AS</span> tier_worst_rate,
    
    <span class="code-comment">-- Performance gap analysis</span>
    <span class="sql-function">ROUND</span>(default_rate - <span class="sql-function">FIRST_VALUE</span>(default_rate) <span class="sql-keyword">OVER</span> (
        <span class="sql-keyword">PARTITION BY</span> tier_classification 
        <span class="sql-keyword">ORDER BY</span> default_rate
    ), 2) <span class="sql-keyword">AS</span> gap_vs_tier_best,
    
    <span class="code-comment">-- Executive decision framework</span>
    <span class="sql-keyword">CASE</span> 
        <span class="sql-keyword">WHEN</span> <span class="sql-function">RANK</span>() <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> default_rate <span class="sql-keyword">DESC</span>) <= 3
             <span class="sql-keyword">AND</span> <span class="sql-function">NTILE</span>(4) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> portfolio_value <span class="sql-keyword">DESC</span>) <= 2
        <span class="sql-keyword">THEN</span> <span class="sql-string">'TERMINATE IMMEDIATELY'</span>
        
        <span class="sql-keyword">WHEN</span> <span class="sql-function">RANK</span>() <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> default_rate <span class="sql-keyword">DESC</span>) <= 5
        <span class="sql-keyword">THEN</span> <span class="sql-string">'URGENT REVIEW REQUIRED'</span>
        
        <span class="sql-keyword">WHEN</span> <span class="sql-function">NTILE</span>(4) <span class="sql-keyword">OVER</span> (<span class="sql-keyword">ORDER BY</span> default_rate) = 1
        <span class="sql-keyword">THEN</span> <span class="sql-string">'CHAMPION PARTNER'</span>
        
        <span class="sql-keyword">WHEN</span> default_rate > 25
        <span class="sql-keyword">THEN</span> <span class="sql-string">'RENEGOTIATE TERMS'</span>
        
        <span class="sql-keyword">ELSE</span> <span class="sql-string">'STANDARD MONITORING'</span>
    <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> partnership_action,
    
    <span class="code-comment">-- Partnership effectiveness score</span>
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">GREATEST</span>(0, 100 - (default_rate * 2)), 1
    ) <span class="sql-keyword">AS</span> effectiveness_score

<span class="sql-keyword">FROM</span> institution_base

<span class="sql-keyword">ORDER BY</span> 
    overall_risk_rank, 
    total_losses <span class="sql-keyword">DESC</span>;</div>

        <h4>Expected Output (Complete Partnership Analysis):</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>institution_name</th>
                    <th>location</th>
                    <th>region</th>
                    <th>tier_classification</th>
                    <th>institution_type</th>
                    <th>students_funded</th>
                    <th>total_loans</th>
                    <th>portfolio_value</th>
                    <th>default_rate</th>
                    <th>losses</th>
                    <th>overall_risk_rank</th>
                    <th>tier_risk_rank</th>
                    <th>termination_priority</th>
                    <th>risk_quartile</th>
                    <th>value_quartile</th>
                    <th>tier_best_rate</th>
                    <th>tier_worst_rate</th>
                    <th>gap_vs_tier_best</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Government Law University</td>
                    <td>Raipur, Chhattisgarh</td>
                    <td>Central</td>
                    <td>Tier3</td>
                    <td>University</td>
                    <td>6</td>
                    <td>6</td>
                    <td>‚Çπ0.2 Cr</td>
                    <td>33%</td>
                    <td>‚Çπ0.07 Cr</td>
                    <td>1</td>
                    <td>1</td>
                    <td>1</td>
                    <td>4</td>
                    <td>2</td>
                    <td>0</td>
                    <td>33</td>
                    <td>33</td>
                </tr>
                <tr>
                    <td>Central Arts & Science University</td>
                    <td>Bhubaneswar, Odisha</td>
                    <td>East</td>
                    <td>Tier3</td>
                    <td>University</td>
                    <td>5</td>
                    <td>5</td>
                    <td>‚Çπ0.34 Cr</td>
                    <td>20%</td>
                    <td>‚Çπ0.07 Cr</td>
                    <td>2</td>
                    <td>2</td>
                    <td>2</td>
                    <td>2</td>
                    <td>1</td>
                    <td>0</td>
                    <td>33</td>
                    <td>20</td>
                </tr>
                <tr>
                    <td>Modern Engineering College</td>
                    <td>Bhopal, Madhya Pradesh</td>
                    <td>Central</td>
                    <td>Tier2</td>
                    <td>College</td>
                    <td>5</td>
                    <td>5</td>
                    <td>‚Çπ0.33 Cr</td>
                    <td>20%</td>
                    <td>‚Çπ0.07 Cr</td>
                    <td>2</td>
                    <td>1</td>
                    <td>3</td>
                    <td>2</td>
                    <td>1</td>
                    <td>0</td>
                    <td>20</td>
                    <td>20</td>
                </tr>
                <tr>
                    <td>Government Technology College</td>
                    <td>Jaipur, Rajasthan</td>
                    <td>North</td>
                    <td>Tier2</td>
                    <td>College</td>
                    <td>5</td>
                    <td>5</td>
                    <td>‚Çπ0.24 Cr</td>
                    <td>20%</td>
                    <td>‚Çπ0.05 Cr</td>
                    <td>2</td>
                    <td>1</td>
                    <td>4</td>
                    <td>2</td>
                    <td>1</td>
                    <td>0</td>
                    <td>20</td>
                    <td>20</td>
                </tr>
                <tr>
                    <td>State Management College</td>
                    <td>Jammu, Jammu and Kashmir</td>
                    <td>North</td>
                    <td>Tier3</td>
                    <td>College</td>
                    <td>5</td>
                    <td>5</td>
                    <td>‚Çπ0.2 Cr</td>
                    <td>20%</td>
                    <td>‚Çπ0.05 Cr</td>
                    <td>2</td>
                    <td>2</td>
                    <td>5</td>
                    <td>3</td>
                    <td>2</td>
                    <td>0</td>
                    <td>33</td>
                    <td>20</td>
                </tr>
                <tr>
                    <td>National Management College</td>
                    <td>Hyderabad, Telangana</td>
                    <td>South</td>
                    <td>Tier1</td>
                    <td>College</td>
                    <td>5</td>
                    <td>5</td>
                    <td>‚Çπ0.23 Cr</td>
                    <td>20%</td>
                    <td>‚Çπ0.04 Cr</td>
                    <td>2</td>
                    <td>1</td>
                    <td>6</td>
                    <td>3</td>
                    <td>1</td>
                    <td>0</td>
                    <td>20</td>
                    <td>20</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="summary-section">
        <h2>üìã SESSION 4 COMPREHENSIVE SUMMARY</h2>
        
        <h3>üéØ PARTNERSHIP ANALYSIS ACHIEVEMENTS</h3>
        <div class="validation-box">
            <h4>Critical Partnership Intelligence Delivered:</h4>
            <ul>
                <li><strong>Termination Targets Identified:</strong> Top 3 institutions with 60-67% default rates destroying ‚Çπ1.50 Cr value</li>
                <li><strong>Champion Partners Discovered:</strong> Central University (9.52% defaults) proves excellent partnerships possible</li>
                <li><strong>Tier Performance Gaps:</strong> 50.48% spread within Tier1 shows management quality variance</li>
                <li><strong>Quartile Strategy Framework:</strong> Clear expansion vs termination decisions for 25% each</li>
                <li><strong>Trend Analysis Warnings:</strong> 35% deterioration in 3 months = immediate intervention required</li>
            </ul>
        </div>

        <h3>üí° STRATEGIC BUSINESS INSIGHTS</h3>
        <div class="info-box">
            <h4>Partnership Portfolio Transformation Required:</h4>
            <ul>
                <li><strong>Elite Institution Failures:</strong> Tier1 institutions performing worse than Tier2/Tier3</li>
                <li><strong>Geographic Concentration Risk:</strong> Crisis spans multiple regions and city tiers</li>
                <li><strong>Partnership Due Diligence Failure:</strong> Current selection criteria completely ineffective</li>
                <li><strong>Immediate Portfolio Cleanup:</strong> ‚Çπ1.50 Cr at immediate risk from worst 3 partnerships</li>
                <li><strong>Expansion Opportunities:</strong> Champion partners justify 50-100% allocation increases</li>
            </ul>
        </div>

        <h3>üîß SQL WINDOW FUNCTIONS MASTERED</h3>
        <div class="learning-tip">
            <h4>Advanced Technical Competencies Developed:</h4>
            <ul>
                <li><strong>RANK() & DENSE_RANK():</strong> Competitive performance rankings within peer groups</li>
                <li><strong>ROW_NUMBER():</strong> Precise ordering for tie-breaking in critical termination decisions</li>
                <li><strong>NTILE():</strong> Quartile-based strategic portfolio segmentation and resource allocation</li>
                <li><strong>FIRST_VALUE() & LAST_VALUE():</strong> Benchmark analysis against best/worst performers</li>
                <li><strong>LAG() & LEAD():</strong> Trend analysis for predictive partnership management</li>
                <li><strong>Complex Window Clauses:</strong> Partitioning, ordering, and frame specifications</li>
            </ul>
        </div>

        <h3>üöÄ NEXT STEPS PREPARATION</h3>
        <div class="objective-box">
            <h4>Foundation for Time Intelligence Analysis:</h4>
            <p><strong>Session 5:</strong> Portfolio Performance Trends - "When did our lending standards collapse?"</p>
            <p><strong>Key Questions:</strong> Which time periods show crisis emergence? How do loan cohorts perform over time?</p>
            <p><strong>Technical Focus:</strong> Date/time functions, period-over-period analysis, cohort analytics</p>
        </div>
    </div>

    <div class="footer">
        <p><strong>¬© 2025 Skill AI Path. All Rights Reserved.</strong></p>
        <p>Created by: Viresh Gendle | tech@skillaipath.com | skillaipath.com</p>
        <p>Licensed for educational and internal business use. Attribution required when sharing. Commercial redistribution prohibited.</p>
    </div>
</body>
</html>